<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4361ee">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>e-HASIL FPMSB TENANG</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
/* =========================================================================
   THEME TOKENS (LIGHT DEFAULT + DARK OVERRIDE)
   ========================================================================= */

:root {
  /* Brand */
  --primary: #4361ee;
  --primary-2: #3a0ca3;
  --primary-grad: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);

  /* Semantic */
  --success: #05cd99;
  --warning: #ffb547;
  --danger: #ee5d50;

  /* Surfaces / text (LIGHT) */
  --bg-body: #f4f7fe;
  --surface: #ffffff;
  --surface-2: #f9fbff;
  --surface-3: #f4f7fe;
  --border: rgba(15, 23, 42, 0.08);

  --text-main: #2b3674;
  --text-muted: #a3aed0;

  /* Effects */
  --shadow-card: 0 20px 27px 0 rgba(0, 0, 0, 0.05);
  --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.10);
  --radius: 20px;

  /* Button glow strengths */
  --glow-primary: 0 0 0 4px rgba(67, 97, 238, 0.18), 0 12px 30px rgba(67, 97, 238, 0.20);
  --glow-success: 0 0 0 4px rgba(5, 205, 153, 0.16), 0 12px 30px rgba(5, 205, 153, 0.18);
  --glow-warning: 0 0 0 4px rgba(255, 181, 71, 0.16), 0 12px 30px rgba(255, 181, 71, 0.18);
  --glow-danger:  0 0 0 4px rgba(238, 93, 80, 0.16), 0 12px 30px rgba(238, 93, 80, 0.18);

  /* Toast/loader */
  --toast-bg: #1b2559;
  --loader-bg: rgba(255,255,255,0.9);

  /* Input */
  --input-bg: #f4f7fe;
  --input-bg-focus: #ffffff;
  --input-ring: 0 0 0 4px rgba(67, 97, 238, 0.12);

  /* Sidebar */
  --sidebar-bg: rgba(255, 255, 255, 0.95);
  --overlay-bg: rgba(43, 54, 116, 0.3);
}

/* Auto dark mode by OS preference (can be overridden by data-theme) */
@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) {
    --bg-body: #0b1220;
    --surface: #0f172a;
    --surface-2: #0c1529;
    --surface-3: #0b1220;
    --border: rgba(148, 163, 184, 0.18);

    --text-main: #e6eaf5;
    --text-muted: rgba(148, 163, 184, 0.85);

    --shadow-card: 0 20px 40px rgba(0,0,0,0.35);
    --shadow-soft: 0 14px 34px rgba(0,0,0,0.35);

    --toast-bg: #0b1024;
    --loader-bg: rgba(0,0,0,0.55);

    --input-bg: rgba(255,255,255,0.06);
    --input-bg-focus: rgba(255,255,255,0.08);
    --input-ring: 0 0 0 4px rgba(67, 97, 238, 0.20);

    --sidebar-bg: rgba(15, 23, 42, 0.92);
    --overlay-bg: rgba(0, 0, 0, 0.55);
  }
}

/* Manual dark mode (forced) */
:root[data-theme="dark"] {
  --bg-body: #0b1220;
  --surface: #0f172a;
  --surface-2: #0c1529;
  --surface-3: #0b1220;
  --border: rgba(148, 163, 184, 0.18);

  --text-main: #e6eaf5;
  --text-muted: rgba(148, 163, 184, 0.85);

  --shadow-card: 0 20px 40px rgba(0,0,0,0.35);
  --shadow-soft: 0 14px 34px rgba(0,0,0,0.35);

  --toast-bg: #0b1024;
  --loader-bg: rgba(0,0,0,0.55);

  --input-bg: rgba(255,255,255,0.06);
  --input-bg-focus: rgba(255,255,255,0.08);
  --input-ring: 0 0 0 4px rgba(67, 97, 238, 0.20);

  --sidebar-bg: rgba(15, 23, 42, 0.92);
  --overlay-bg: rgba(0, 0, 0, 0.55);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
::-webkit-scrollbar { display: none; }

body { 
  font-family: 'Plus Jakarta Sans', sans-serif; 
  background: radial-gradient(1100px 600px at 30% -10%, rgba(67,97,238,0.16), transparent 55%),
              radial-gradient(900px 600px at 110% 10%, rgba(58,12,163,0.14), transparent 55%),
              var(--bg-body);
  color: var(--text-main); 
  margin: 0; 
  min-height: 100vh; 
  padding-top: 80px; 
  display: flex; 
  justify-content: center; 
}

.app-container { width: 100%; max-width: 500px; padding: 20px; }

/* --- HEADER (Curved & Gradient) --- */
.header {
  position: fixed; top: 0; left: 0; width: 100%; height: 70px;
  background: var(--primary-grad);
  color: white; display: flex; align-items: center; padding: 0 18px;
  z-index: 1000; 
  box-shadow: 0 10px 30px rgba(67, 97, 238, 0.35);
  border-bottom-left-radius: 30px; 
  border-bottom-right-radius: 30px;
  overflow: hidden;
}
.header:before{
  content:"";
  position:absolute; inset:-80px -120px auto auto;
  width: 240px; height: 240px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28), transparent 60%);
  transform: rotate(12deg);
  pointer-events:none;
  opacity:0.7;
}

.menu-btn { font-size: 28px; cursor: pointer; margin-right: 12px; transition:0.2s; }
.menu-btn:active { transform: scale(0.9); }
.header h3 { font-size: 18px; font-weight: 800; margin: 0; flex-grow: 1; letter-spacing: 0.5px; }

/* Theme toggle button (added) */
.theme-toggle {
  width: 42px; height: 42px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.28);
  background: rgba(255,255,255,0.14);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  transition: 0.25s;
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
  user-select:none;
  z-index: 2;
}
.theme-toggle:active { transform: scale(0.96); }
.theme-toggle:hover { background: rgba(255,255,255,0.18); box-shadow: 0 12px 30px rgba(0,0,0,0.16); }
.theme-toggle i { font-size: 22px; }

/* --- SIDEBAR (Glassmorphism) --- */
.sidebar {
  position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
  background: var(--sidebar-bg);
  backdrop-filter: blur(12px);
  z-index: 1100; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 10px 0 40px rgba(0,0,0,0.18);
  display: flex; flex-direction: column;
  border-right: 1px solid var(--border);
}
.sidebar.open { left: 0; }

.overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--overlay-bg);
  z-index: 1050; display: none;
  backdrop-filter: blur(4px);
}
.overlay.open { display: block; }

.sb-header { 
  height: 180px; 
  background: var(--primary-grad); 
  color: white; 
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  align-items: center; 
  border-bottom-right-radius: 40px; 
}

/* ========= UPGRADE BARU: LOGO SIDEBAR =========
   Guna <img class="sb-logo" src="https://i.imgur.com/APuF5wN.png">
   untuk replace icon "spa"
*/
.sb-logo{
  width: 86px;
  height: 86px;
  object-fit: contain;
  border-radius: 22px;
  padding: 10px;
  background: rgba(255,255,255,0.14);
  border: 1px solid rgba(255,255,255,0.28);
  box-shadow: 0 18px 38px rgba(0,0,0,0.22);
  transition: 0.25s;
}
.sb-logo:active{ transform: scale(0.98); }
.sb-logo:hover{ transform: scale(1.05); }

.sb-logo-text { font-size: 18px; font-weight: 800; margin-top: 10px; letter-spacing: 1px; }

.sb-menu { flex-grow: 1; padding: 20px 0; overflow-y: auto; }
.sb-item {
  padding: 15px 30px; display: flex; align-items: center;
  color: var(--text-muted); font-weight: 700; transition: 0.2s;
  border-left: 4px solid transparent; cursor: pointer; font-size: 14px;
}
.sb-item i { margin-right: 15px; font-size: 22px; color: var(--text-muted); }
.sb-item.active { background: rgba(67, 97, 238, 0.10); color: var(--primary); border-left-color: var(--primary); }
.sb-item.active i { color: var(--primary); }

/* --- CARDS & UI ELEMENTS --- */
.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.00)), var(--surface);
  border-radius: var(--radius);
  padding: 25px; margin-bottom: 25px; 
  box-shadow: var(--shadow-card);
  border: 1px solid var(--border);
}

.pill {
  background: rgba(67, 97, 238, 0.14); color: var(--primary);
  padding: 8px 16px; border-radius: 30px; font-size: 11px; font-weight: 900;
  letter-spacing: 1px; width: fit-content; margin: 0 auto 20px auto;
  text-transform: uppercase; display: block;
  border: 1px solid rgba(67,97,238,0.18);
  box-shadow: 0 12px 22px rgba(67,97,238,0.10);
}

.input-group { margin-bottom: 20px; }
label { display: block; font-size: 12px; font-weight: 800; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

.input-wrapper { position: relative; }
.input-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 20px; }

select, input, textarea {
  width: 100%; padding: 14px 15px 14px 45px;
  border: 1px solid var(--border);
  background: var(--input-bg);
  border-radius: 15px; font-size: 15px; font-weight: 650;
  font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main);
  transition: 0.25s; appearance: none;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
}
select:focus, input:focus, textarea:focus {
  background: var(--input-bg-focus);
  border-color: rgba(67, 97, 238, 0.65);
  box-shadow: var(--input-ring);
  outline: none;
}

.big-input {
  font-size: 32px !important; font-weight: 900;
  text-align: center; padding-left: 20px !important;
  color: var(--primary); letter-spacing: -1px;
}

/* --- BUTTONS: warna + glow + ripple --- */
button {
  width: 100%; padding: 16px;
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 16px;
  font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 900; font-size: 14px;
  text-transform: uppercase; cursor: pointer; letter-spacing: 0.5px;
  transition: 0.18s ease;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  position: relative;
  overflow: hidden;
  transform: translateZ(0);
  user-select: none;
}
button:active { transform: scale(0.985); }

/* ripple (pure CSS) */
button:after{
  content:"";
  position:absolute;
  inset:auto;
  width: 10px; height: 10px;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%) scale(1);
  opacity: 0;
  border-radius: 999px;
  background: rgba(255,255,255,0.35);
  pointer-events:none;
}
button:active:after{
  animation: ripple 480ms ease-out;
}
@keyframes ripple {
  0% { opacity: 0.35; transform: translate(-50%,-50%) scale(1); }
  100% { opacity: 0; transform: translate(-50%,-50%) scale(18); }
}

.btn-primary {
  background: linear-gradient(135deg, #4361ee, #3a0ca3);
  color: #fff;
  box-shadow: 0 12px 28px rgba(67, 97, 238, 0.25);
}
.btn-primary:hover { box-shadow: var(--glow-primary); }
.btn-primary:active { box-shadow: 0 8px 18px rgba(67,97,238,0.20); }

.btn-success { background: linear-gradient(135deg, #05cd99, #02a176); color: white; box-shadow: 0 12px 26px rgba(5, 205, 153, 0.22); }
.btn-success:hover { box-shadow: var(--glow-success); }
.btn-success:active { box-shadow: 0 8px 18px rgba(5,205,153,0.18); }

.btn-warning { background: linear-gradient(135deg, #ffb547, #e0921f); color: white; box-shadow: 0 12px 26px rgba(255, 181, 71, 0.22); }
.btn-warning:hover { box-shadow: var(--glow-warning); }
.btn-warning:active { box-shadow: 0 8px 18px rgba(255,181,71,0.18); }

.btn-danger { background: linear-gradient(135deg, #ee5d50, #c93b2e); color: white; box-shadow: 0 12px 26px rgba(238, 93, 80, 0.22); }
.btn-danger:hover { box-shadow: var(--glow-danger); }
.btn-danger:active { box-shadow: 0 8px 18px rgba(238,93,80,0.18); }

.btn-secondary {
  background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.02)), var(--surface);
  border: 1px solid var(--border);
  color: var(--text-main);
  box-shadow: var(--shadow-soft);
}
.btn-secondary:hover { box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.12), var(--shadow-soft); transform: translateY(-1px); }
.btn-secondary:active { transform: scale(0.985); box-shadow: var(--shadow-soft); }

/* =========================================================
   PATCH: BUTTON KHAS (REFRESH / PO / RUMUSAN) ADA WARNA
   ========================================================= */
.btn-refresh{
  background: linear-gradient(135deg, #6d28d9, #4f46e5);
  color:#fff;
  box-shadow: 0 12px 26px rgba(79,70,229,0.22);
}
.btn-refresh:hover{ box-shadow: 0 0 0 4px rgba(79,70,229,0.18), 0 12px 30px rgba(79,70,229,0.22); }
.btn-refresh:active{ box-shadow: 0 8px 18px rgba(79,70,229,0.18); }

.btn-po{
  background: linear-gradient(135deg, #06b6d4, #0ea5e9);
  color:#fff;
  box-shadow: 0 12px 26px rgba(14,165,233,0.22);
}
.btn-po:hover{ box-shadow: 0 0 0 4px rgba(14,165,233,0.18), 0 12px 30px rgba(14,165,233,0.22); }
.btn-po:active{ box-shadow: 0 8px 18px rgba(14,165,233,0.18); }

.btn-rumusan{
  background: linear-gradient(135deg, #ec4899, #8b5cf6);
  color:#fff;
  box-shadow: 0 12px 26px rgba(236,72,153,0.22);
}
.btn-rumusan:hover{ box-shadow: 0 0 0 4px rgba(236,72,153,0.18), 0 12px 30px rgba(139,92,246,0.18); }
.btn-rumusan:active{ box-shadow: 0 8px 18px rgba(236,72,153,0.18); }

/* --- BULK ROWS --- */
.bulk-row { 
  display: flex; align-items: center; gap: 15px; margin-bottom: 12px; 
  padding: 10px 15px;
  background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.00)), var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  transition: 0.18s ease;
  box-shadow: 0 10px 20px rgba(0,0,0,0.06);
}
.bulk-row:focus-within { border-color: rgba(67,97,238,0.55); box-shadow: var(--input-ring); transform: translateX(4px); }
.bulk-row label { flex: 1; margin: 0; color: var(--text-main); font-size: 13px; font-weight: 800; text-transform: none; }
.bulk-row input { flex: 1; padding: 10px; padding-left: 15px; text-align: right; background: var(--input-bg); border-radius: 10px; font-weight: 900; color: var(--primary); }

/* --- INFO BOX & BADGES --- */
.info-status { 
  background: rgba(5, 205, 153, 0.12);
  border: 1px solid rgba(5, 205, 153, 0.22);
  border-radius: 16px; padding: 15px; margin: 20px 0; 
  display: flex; justify-content: space-between; align-items: center; 
}
.info-item { text-align: center; width: 45%; }
.info-item span { font-size: 11px; color: rgba(5,205,153,0.95); font-weight: 900; opacity: 0.9; }
.info-item b { display: block; font-size: 18px; color: var(--success); margin-top: 2px; letter-spacing: -0.5px; font-weight: 900; }
.info-divider { width: 2px; height: 30px; background: rgba(5, 205, 153, 0.22); }

.stats-header { 
  background: linear-gradient(135deg, rgba(67,97,238,0.14), rgba(67,97,238,0.05));
  color: var(--primary);
  padding: 12px; border-radius: 14px; margin-bottom: 20px; 
  font-size: 12px; font-weight: 900; text-align: center; 
  border: 1px solid rgba(67, 97, 238, 0.18);
  display: none; 
  box-shadow: 0 12px 24px rgba(67,97,238,0.10);
}
.stat-badge { 
  font-size: 10px; color: white; background: rgba(148, 163, 184, 0.85);
  padding: 3px 8px; border-radius: 8px; margin-left: 6px; 
  vertical-align: middle; font-weight: 900; 
}

/* --- LOADER & TOAST --- */
#loader {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--loader-bg);
  backdrop-filter: blur(6px);
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  z-index: 2000; display: none;
}
.spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.25); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#toast-box {
  position: fixed; bottom: 30px; left: 50%;
  transform: translateX(-50%) translateY(150px);
  min-width: 320px;
  padding: 16px 24px;
  background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.00)), var(--toast-bg);
  color: #fff;
  border-radius: 50px;
  display: flex; align-items: center; gap: 15px;
  z-index: 3000;
  box-shadow: 0 18px 50px rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.10);
  transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#toast-box.show { transform: translateX(-50%) translateY(0); }
#toast-box.success i { color: var(--success); }
#toast-box.error i { color: var(--danger); }
#toast-box.warning i { color: var(--warning); }

.page-section { display: none; animation: fadeUp 0.35s ease-out; }
.page-section.active { display: block; }
@keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }

/* Small polish: icons */
i.material-icons-round { user-select:none; }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div style="margin-top:20px; font-size:13px; font-weight:900; color:rgba(148,163,184,0.95); letter-spacing:1px;">SILA TUNGGU...</div></div>
<div id="toast-box"><i class="material-icons-round" id="toast-icon">notifications</i><span id="toast-msg">Notifikasi</span></div>

<div class="header">
  <i class="material-icons-round menu-btn" onclick="toggleMenu()">menu</i>
  <h3>e-HASIL FPMSB TENANG</h3>
  <div class="theme-toggle" onclick="toggleTheme()" title="Dark/Light">
    <i class="material-icons-round" id="themeIcon">dark_mode</i>
  </div>
</div>

<div class="overlay" onclick="toggleMenu()"></div>
<div class="sidebar">
  <div class="sb-header"><img class="sb-logo" src="https://i.imgur.com/APuF5wN.png" alt="Logo"><div class="sb-logo-text">SISTEM LADANG</div></div>
  <div class="sb-menu">
    <div class="sb-item active" onclick="nav('page-hasil', this)"><i class="material-icons-round">bar_chart</i>INPUT HASIL</div>
    <div class="sb-item" onclick="nav('page-muda', this)"><i class="material-icons-round">eco</i>BTB MUDA</div>
    <div class="sb-item" onclick="nav('page-penalti', this)"><i class="material-icons-round">warning</i>PENALTI</div>
    <div class="sb-item" onclick="nav('page-tandan', this)"><i class="material-icons-round">inventory_2</i>REKOD TANDAN</div>
    <div class="sb-item" onclick="nav('page-admin', this)"><i class="material-icons-round">settings</i>ADMIN & REPORT</div>
  </div>
</div>

<div class="app-container">

  <div id="page-hasil" class="page-section active">
    <div class="pill">MODE: HASIL</div>
    <div class="card">
      <div style="display:flex; gap:15px; margin-bottom:20px;">
        <div class="input-wrapper" style="flex:1"><i class="material-icons-round">calendar_today</i><input type="date" id="date-hasil" onchange="renderPeringkatHasil()"></div>
        <div class="input-wrapper" style="width:130px"><i class="material-icons-round">tune</i><select id="mode-hasil" onchange="renderPeringkatHasil()"><option value="TAN">TAN</option><option value="PUS_TUAI">HEKTAR</option></select></div>
      </div>
      <div class="input-group">
        <label>PERINGKAT <span id="info-luas-header" style="float:right; color:var(--success);"></span></label>
        <div class="input-wrapper"><i class="material-icons-round">layers</i><select id="sel-pkt-hasil" onchange="renderTeamHasil()"></select></div>
      </div>
      <div id="wrap-live-display" class="card" style="background:rgba(255,181,71,0.12); border:1px solid rgba(255,181,71,0.30); text-align:center; padding:20px; margin-top:15px; display:none; box-shadow:none;">
        <label id="lbl-display" style="color:var(--warning); margin-bottom:5px;">JUMLAH TAN (HARI INI)</label>
        <div id="display-tan-live" style="font-size:36px; font-weight:900; color:#e0921f; letter-spacing:-1px;">0.00</div>
        <small id="small-hint" style="color:rgba(255,181,71,0.85); font-size:11px; display:block; margin-top:5px; font-weight:700;">Auto-Kira aktif. Sila tekan Save Master.</small>
      </div>
      <div id="box-status-tuai" class="info-status" style="display:none;">
         <div class="info-item"><span>SIAP TUAI</span><b id="valSiap">0.00 Ha</b></div>
         <div class="info-divider"></div>
         <div class="info-item"><span>BAKI LUAS</span><b id="valBaki" style="color:var(--danger)">0.00 Ha</b></div>
      </div>
      <div id="wrap-team-hasil" style="margin-top:20px;"></div>
      <div id="wrap-single-hasil" class="input-group" style="margin-top:25px; display:none;">
        <label id="lbl-val-hasil">NILAI</label>
        <input type="text" id="val-hasil" class="big-input" placeholder="0.00" inputmode="text" onfocus="onFocusInput(this,'hasil')" onblur="onBlurInput(this,'hasil')" oninput="onInputHandler(this,'hasil')">
      </div>
      <div style="margin-top:30px; border-top:1px dashed rgba(148, 163, 184, 0.35); padding-top:20px;">
        <!-- PATCH: guna btn-refresh (bukan btn-secondary) -->
        <button id="btnRefRumusan" class="btn-refresh" onclick="runAdmin('refreshRumusan')" style="display:none; margin-bottom:15px; width:100%">
          <i class="material-icons-round">sync</i> REFRESH RUMUSAN
        </button>

        <button class="btn-success" onclick="processSaveMaster()" style="width:100%"><i class="material-icons-round">cloud_upload</i> SAVE MASTER</button>
      </div>
    </div>
  </div>

  <div id="page-muda" class="page-section">
    <div class="pill">MODE: BTB MUDA</div>
    <div class="card">
      <div class="input-group"><div class="input-wrapper"><i class="material-icons-round">calendar_today</i><input type="date" id="date-muda"></div></div>
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons-round">layers</i><select id="sel-pkt-muda" onchange="renderTeamMuda()"><option value="PKT001G">PKT 001G</option><option value="PKT002">PKT 002</option><option value="PKT003G">PKT 003G</option><option value="PKT004A">PKT 004A</option></select></div>
      </div>
      
      <div id="stats-header-muda" class="stats-header"></div>

      <div id="wrap-team-muda" style="margin-top:20px;"></div>
      <div class="btn-group" style="margin-top:30px;"><button class="btn-success" onclick="saveData('muda')"><i class="material-icons-round">check_circle</i> SIMPAN MUDA</button></div>
    </div>
  </div>

  <div id="page-penalti" class="page-section">
    <div class="pill">MODE: PENALTI</div>
    <div class="card">
      <div style="display:flex; gap:15px; margin-bottom:20px;">
        <div class="input-wrapper" style="flex:1"><i class="material-icons-round">calendar_today</i><input type="date" id="date-penalti"></div>
        <div class="input-wrapper" style="width:130px"><i class="material-icons-round">category</i><select id="type-penalti" onchange="renderPeringkatPenalti()"><option value="MENGKAL">MENGKAL</option><option value="LAMA">LAMA</option></select></div>
      </div>
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons-round">layers</i><select id="sel-pkt-penalti" onchange="renderPeringkatPenalti()"><option value="PKT001">PKT 001</option><option value="PKT001G">PKT 001G</option><option value="PKT002">PKT 002</option><option value="PKT003G">PKT 003G</option><option value="PKT004">PKT 004</option></select></div>
      </div>
      <div class="input-group" style="margin-top:25px;">
        <label>BILANGAN TANDAN <span id="stat-penalti" style="float:right; font-weight:900; color:var(--primary); font-size:11px;"></span></label>
        <input type="text" id="val-penalti" class="big-input" placeholder="0" inputmode="text" onfocus="onFocusInput(this,'penalti')" onblur="onBlurInput(this,'penalti')" oninput="onInputHandler(this,'penalti')">
      </div>
      <div class="btn-group" style="margin-top:30px;"><button class="btn-danger" onclick="saveData('penalti')"><i class="material-icons-round">error_outline</i> SIMPAN PENALTI</button></div>
    </div>
  </div>

  <div id="page-tandan" class="page-section">
    <div class="pill">MODE: REKOD TANDAN</div>
    <div class="card">
      <div class="input-group"><div class="input-wrapper"><i class="material-icons-round">calendar_today</i><input type="date" id="date-tandan"></div></div>
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons-round">layers</i><select id="sel-pkt-tandan" onchange="renderTeamTandan()"><option value="PKT004">PKT 004</option><option value="PKT001">PKT 001</option><option value="PKT002">PKT 002</option><option value="PKT001G">PKT 001G</option><option value="PKT003G">PKT 003G</option></select></div>
      </div>
      
      <div id="stats-header-tandan" class="stats-header"></div>

      <div id="wrap-team-tandan" style="margin-top:20px;"></div>
      <div class="btn-group" style="margin-top:30px;"><button class="btn-warning" onclick="saveData('tandan')"><i class="material-icons-round">inventory_2</i> SIMPAN TANDAN</button></div>
    </div>
  </div>

  <div id="page-admin" class="page-section">
    <div class="pill">ADMIN & LAPORAN</div>
    <div class="card">
      <label>JANA LAPORAN HARIAN</label>

      <!-- PATCH: PO & RUMUSAN guna button berwarna -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
        <button class="btn-po" onclick="getReport('PO')">PO</button>
        <button class="btn-rumusan" onclick="getReport('RUMUSAN')">RUMUSAN</button>
      </div>

      <button class="btn-primary" onclick="getReport('ALL')" style="margin-top:20px; width:100%"><i class="material-icons-round">description</i> JANA SEMUA</button>
      <div id="reportResult" style="margin-top:20px; display:none;">
        <textarea id="report-out" style="width:100%; height:200px; padding:15px; border-radius:16px; border:1px solid var(--border); background: var(--input-bg); font-family:monospace; color: var(--text-main);" readonly></textarea>
        <button class="btn-success" onclick="copyText()" style="margin-top:15px; width:100%"><i class="material-icons-round">content_copy</i> SALIN TEKS</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================================
   THEME TOGGLE (added) - tidak kacau fungsi bawah, hanya UI theme
   ========================================================================= */
(function initTheme(){
  try {
    const saved = localStorage.getItem('eh_theme'); // 'dark' | 'light' | null
    if (saved === 'dark' || saved === 'light') document.documentElement.setAttribute('data-theme', saved);
    syncThemeIcon();
  } catch(e){}
})();

function syncThemeIcon(){
  const icon = document.getElementById('themeIcon');
  if(!icon) return;
  const t = document.documentElement.getAttribute('data-theme'); // 'dark' or 'light' or null
  // If t null => follow OS. show icon based on current computed scheme.
  let isDark = false;
  if (t === 'dark') isDark = true;
  else if (t === 'light') isDark = false;
  else isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

  icon.textContent = isDark ? 'light_mode' : 'dark_mode';
}

function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme');
  let next;
  if(cur === 'dark') next = 'light';
  else if(cur === 'light') next = 'dark';
  else {
    // follow OS -> toggle to opposite of current OS
    const osDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    next = osDark ? 'light' : 'dark';
  }
  document.documentElement.setAttribute('data-theme', next);
  try { localStorage.setItem('eh_theme', next); } catch(e){}
  syncThemeIcon();
}

/* Sync icon when OS theme changes (if user didn't force theme) */
try {
  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  mq.addEventListener('change', () => {
    const forced = document.documentElement.getAttribute('data-theme');
    if(!forced) syncThemeIcon();
  });
} catch(e){}

const API_URL = "https://script.google.com/macros/s/AKfycbww-dk_HH7KcOljdfG3ysEaow_X-ZVATDx2--2YoK44KnRTlTKX57leKCGckdSsjnwukA/exec"; 

const HASIL_CFG = { pkt: ["PKT004","PKT001","PKT002","PKT001G","PKT003G","RUMUSAN"], teams: { PKT004: ["BLOK 1","BLOK 2","BLOK 3","BLOK 4","BLOK 5"], PKT002: ["TEAM PKT","TEAM 1","TEAM 2","TEAM TKA","TEAM TKA BAJA"], PKT001G:["HABIBI","P.BOWO","MEGA","TEAM TKA","TEAM TKA BAJA"], PKT003G:["TEAM KIRI","TEAM KANAN","TEAM BLOK C","TEAM TKA","TEAM TKA BAJA"] } };
const MUDA_CFG = { "PKT001G": ["HABIBI", "P.BOWO", "MEGA", "TKA"], "PKT002": ["TEAM PKT", "TEAM 1", "TEAM 2", "TKA"], "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"], "PKT004A": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"] };
const TANDAN_CFG = { "PKT004": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"], "PKT001": ["TKA"], "PKT002": ["TEAM PKT", "TEAM 1", "TEAM 2"], "PKT001G": ["HABIBI", "P.BOWO", "MEGA"], "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"] };

let FORMULA_STORE = {}; 
let HARVEST_STATS = null;

window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  ['date-hasil','date-muda','date-penalti','date-tandan'].forEach(id => document.getElementById(id).value = today);
  renderPeringkatHasil(); renderTeamMuda(); renderTeamTandan(); renderPeringkatPenalti();
  fetchStats(); 
};

function toggleMenu() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('open'); }
function nav(id, el) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  if(el) el.classList.add('active');
  toggleMenu();
}

function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast-box');
  const icon = document.getElementById('toast-icon');
  document.getElementById('toast-msg').textContent = msg;
  toast.className = 'show ' + type;
  icon.textContent = (type === 'success') ? 'check_circle' : (type === 'warning' ? 'report_problem' : 'error');
  setTimeout(() => { toast.classList.remove('show'); }, 3500);
}

function updateLiveTotal() {
  const p = document.getElementById('sel-pkt-hasil').value;
  const mode = document.getElementById('mode-hasil').value;
  if (p === "RUMUSAN" || mode !== "TAN") return;
  let total = 0;
  document.querySelectorAll('.bulk-hasil').forEach(inp => {
    let raw = inp.value.trim();
    if(raw.startsWith('=')) { try { let clean = raw.substring(1); total += Function('"use strict";return (' + clean + ')')() || 0; } catch(e) {} } 
    else { total += parseFloat(raw) || 0; }
  });
  document.getElementById('display-tan-live').textContent = total.toFixed(2);
}

function onInputHandler(el, type) {
  const key = type + (el.dataset.idx !== undefined ? el.dataset.idx : (el.dataset.team || ""));
  FORMULA_STORE[key] = el.value;
  if(type === 'hasil') updateLiveTotal();
}

function onBlurInput(el, type) {
  const key = type + (el.dataset.idx !== undefined ? el.dataset.idx : (el.dataset.team || ""));
  let val = el.value.trim();
  if(!val) { FORMULA_STORE[key] = ""; return; }
  if (val.match(/[+\-*\/]/) && !val.startsWith('=')) { val = "=" + val; FORMULA_STORE[key] = val; }
  if (val.startsWith('=')) {
    try { let result = Function('"use strict";return (' + val.substring(1) + ')')(); if (!isNaN(result)) el.value = (result % 1 !== 0) ? result.toFixed(2) : result; } catch(e) {}
  }
  if(type === 'hasil') updateLiveTotal();
}

function onFocusInput(el, type) {
  const key = type + (el.dataset.idx !== undefined ? el.dataset.idx : (el.dataset.team || ""));
  if (FORMULA_STORE[key] && FORMULA_STORE[key].startsWith('=')) el.value = FORMULA_STORE[key];
}

// --- RENDER LOGIC DENGAN MEMORY WIPE ---
function renderPeringkatHasil() {
  Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith('hasil')) delete FORMULA_STORE[k]; });
  const sel = document.getElementById('sel-pkt-hasil');
  const mode = document.getElementById('mode-hasil').value;
  const list = (mode === "PUS_TUAI") ? HASIL_CFG.pkt.filter(x => x !== "RUMUSAN") : HASIL_CFG.pkt;
  sel.innerHTML = list.map(x => `<option value="${x}">${x}</option>`).join("");
  renderTeamHasil();
}

function renderTeamHasil() {
  Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith('hasil')) delete FORMULA_STORE[k]; });
  const p = document.getElementById('sel-pkt-hasil').value;
  const mode = document.getElementById('mode-hasil').value;
  const wrap = document.getElementById('wrap-team-hasil');
  const wrapSingle = document.getElementById('wrap-single-hasil');
  const wrapLive = document.getElementById('wrap-live-display');
  
  if(p === "RUMUSAN") {
    showToast("Sila klik 'REFRESH RUMUSAN' dahulu!", 'warning');
    document.getElementById('btnRefRumusan').style.display = 'block';
    document.getElementById('lbl-display').textContent = "JUMLAH TAN KESELURUHAN";
    wrap.innerHTML = ""; wrapSingle.style.display = 'none'; wrapLive.style.display = 'block';
    document.getElementById('display-tan-live').textContent = "0.00";
    updateStatsDisplay(p);
    return;
  }
  document.getElementById('btnRefRumusan').style.display = 'none';
  document.getElementById('lbl-display').textContent = "JUMLAH TAN (HARI INI)";

  if(mode === "TAN") {
    wrapSingle.style.display = 'none'; wrapLive.style.display = 'block';
    let teams = (p === "PKT001") ? ["TOTAL"] : (HASIL_CFG.teams[p] || []);
    let html = `<label>MASUKKAN TAN PER TEAM (${p})</label>`;
    teams.forEach((t, i) => {
      html += `<div class="bulk-row"><label>${t}</label><input type="text" class="bulk-hasil" data-idx="${i}" placeholder="0.00" onfocus="onFocusInput(this,'hasil')" onblur="onBlurInput(this,'hasil')" oninput="onInputHandler(this,'hasil')"></div>`;
    });
    wrap.innerHTML = html;
    updateLiveTotal();
  } else {
    wrap.innerHTML = ""; wrapSingle.style.display = 'block'; wrapLive.style.display = 'none';
  }
  updateStatsDisplay(p);
}

function renderTeamMuda() {
  Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith('muda')) delete FORMULA_STORE[k]; });
  const p = document.getElementById('sel-pkt-muda').value;
  let cfg = MUDA_CFG;
  let html = `<label>SENARAI TEAM : ${p}</label>`;
  (cfg[p] || []).forEach(t => {
      html += `<div class="bulk-row"><label id="lbl-muda-${t}">${t}</label><input type="text" class="bulk-muda" data-team="${t}" placeholder="0" onfocus="onFocusInput(this,'muda')" onblur="onBlurInput(this,'muda')" oninput="onInputHandler(this,'muda')"></div>`;
  });
  document.getElementById('wrap-team-muda').innerHTML = html;
  fetchStatsData("MUDA", p); 
}

function renderTeamTandan() {
  Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith('tandan')) delete FORMULA_STORE[k]; });
  const p = document.getElementById('sel-pkt-tandan').value;
  let cfg = TANDAN_CFG;
  let html = `<label>SENARAI TEAM : ${p}</label>`;
  (cfg[p] || []).forEach(t => {
      html += `<div class="bulk-row"><label id="lbl-tandan-${t}">${t}</label><input type="text" class="bulk-tandan" data-team="${t}" placeholder="0" onfocus="onFocusInput(this,'tandan')" onblur="onBlurInput(this,'tandan')" oninput="onInputHandler(this,'tandan')"></div>`;
  });
  document.getElementById('wrap-team-tandan').innerHTML = html;
  fetchStatsData("TANDAN", p);
}

function renderPeringkatPenalti() {
  Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith('penalti')) delete FORMULA_STORE[k]; });
  const p = document.getElementById('sel-pkt-penalti').value;
  const type = document.getElementById('type-penalti').value;
  document.getElementById('stat-penalti').textContent = "Loading...";
  fetchStatsData("PENALTI", p, type);
}

// --- SILENT UPDATE FUNCTION ---
function drawStatsUI(mode, pkt, data) {
  if (mode === "MUDA" || mode === "TANDAN") {
    const header = document.getElementById(mode === "MUDA" ? 'stats-header-muda' : 'stats-header-tandan');
    if(data.totalPkt !== undefined) {
      let txt = `TOTAL PKT: ${data.totalPkt}`;
      if(mode === "TANDAN" && data.berat) {
        const estTon = (data.totalPkt * data.berat / 1000).toFixed(2);
        txt += ` | BERAT: ${estTon} MT`;
      }
      header.textContent = txt;
      header.style.display = 'block';
    } else { header.style.display = 'none'; }

    let cfg = (mode === "MUDA") ? MUDA_CFG : TANDAN_CFG;
    (cfg[pkt] || []).forEach(t => {
        const labelEl = document.getElementById(`lbl-${mode.toLowerCase()}-${t}`);
        if (labelEl) {
            labelEl.innerHTML = t; 
            if (data.teams && data.teams[t] !== undefined) {
                labelEl.innerHTML += ` <span class="stat-badge">${data.teams[t]}</span>`;
            }
        }
    });
  }
  else if (mode === "PENALTI") {
    const el = document.getElementById('stat-penalti');
    if(data.totalType !== undefined) el.textContent = `(Rekod: ${data.totalType})`;
    else el.textContent = "";
  }
}

async function fetchStatsData(mode, pkt, type="") {
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getTeamStats', data: { mode, peringkat: pkt, type } }) });
    const res = await r.json();
    if (res.ok) { drawStatsUI(mode, pkt, res.stats || {}); } 
    else { drawStatsUI(mode, pkt, {}); }
  } catch(e) { console.error(e); }
}

function updateStatsDisplay(p) {
  const box = document.getElementById('box-status-tuai');
  const infoHeaderTxt = document.getElementById('info-luas-header');
  const mode = document.getElementById('mode-hasil').value;

  if(HARVEST_STATS && HARVEST_STATS[p]) {
    if(infoHeaderTxt) infoHeaderTxt.textContent = `â€¢ ${HARVEST_STATS[p].luas.toFixed(2)} Ha`;
    
    if(mode === "PUS_TUAI" && p !== "RUMUSAN") {
      box.style.display = 'flex'; 
      let siap = 0, luas = 0;
      if(HARVEST_STATS && HARVEST_STATS[p]) { siap = HARVEST_STATS[p].siap || 0; luas = HARVEST_STATS[p].luas || 0; }
      const day = Number(document.getElementById('date-hasil').value.split('-')[2]);
      let target = luas;
      if(day >= 16 || siap > luas) target = luas * 2;
      document.getElementById('valSiap').textContent = siap.toFixed(2) + " Ha";
      document.getElementById('valBaki').textContent = (target - siap).toFixed(2) + " Ha";
    } else { box.style.display = 'none'; }
  } else { if(infoHeaderTxt) infoHeaderTxt.textContent = ""; box.style.display = 'none'; }
}

async function processSaveMaster() {
  const loader = document.getElementById('loader');
  const d = document.getElementById(`date-hasil`).value;
  const pkt = document.getElementById('sel-pkt-hasil').value;
  const mode = document.getElementById('mode-hasil').value;
  
  let payload = { peringkat: pkt, tarikh: d, day: Number(d.split('-')[2]) };
  let action = (mode === "TAN") ? "saveTanBulk" : "savePusTuai";

  if(mode === "TAN") {
    payload.list = [];
    document.querySelectorAll('.bulk-hasil').forEach(inp => {
      let val = FORMULA_STORE['hasil' + inp.dataset.idx] || inp.value;
      if(val.trim() !== "" && val.trim() !== "0") payload.list.push({ idx: inp.dataset.idx, val: val });
    });
    if(pkt !== "RUMUSAN" && payload.list.length === 0) return showToast("Sila isi nilai!", 'error');
  } else {
    payload.hektar = FORMULA_STORE['hasil'] || document.getElementById('val-hasil').value;
    if(!payload.hektar) return showToast("Sila isi nilai hektar!", 'error');
  }

  loader.style.display = 'flex';
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data: payload }) });
    const res = await r.json();
    loader.style.display = 'none';
    if(res.ok) { 
        showToast(res.message, 'success'); 
        if(mode === "PUS_TUAI") fetchStats(); 
        
        // --- CLEAR FORMULA STORE SELEPAS SAVE (HASIL) ---
        if(mode === "TAN") {
            document.querySelectorAll('.bulk-hasil').forEach(inp => inp.value = "");
            document.getElementById('display-tan-live').textContent = "0.00";
        } else {
            document.getElementById('val-hasil').value = "";
        }
        Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith('hasil')) delete FORMULA_STORE[k]; });
    } 
    else { showToast(res.message, 'error'); }
  } catch(e) { loader.style.display = 'none'; showToast("Ralat Sambungan!", 'error'); }
}

async function saveData(type) {
  const loader = document.getElementById('loader');
  const d = document.getElementById(`date-${type}`).value;
  const pkt = document.getElementById(`sel-pkt-${type}`).value;
  
  let payload = { peringkat: pkt, tarikh: d, day: Number(d.split('-')[2]) };
  let action = (type === 'muda') ? "saveMudaBulk" : (type === 'tandan' ? "saveTandanBulk" : "savePenalti");
  payload.list = [];

  if(type === 'penalti') {
    payload.type = document.getElementById('type-penalti').value;
    payload.val = FORMULA_STORE['penalti'] || document.getElementById('val-penalti').value;
    if(!payload.val) return showToast("Sila isi nilai!", 'error');
  } else {
    document.querySelectorAll(`.bulk-${type}`).forEach(inp => {
      let val = FORMULA_STORE[type + (inp.dataset.team || "")] || inp.value;
      if(val.trim() !== "") payload.list.push({ team: inp.dataset.team, val: val });
    });
    if(payload.list.length === 0) return showToast("Sila isi nilai!", 'error');
  }

  loader.style.display = 'flex';
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data: payload }) });
    const res = await r.json();
    loader.style.display = 'none';
    if(res.ok) { 
        showToast(res.message, 'success'); 
        
        // --- CLEAR FORMULA STORE SELEPAS SAVE (LAIN-LAIN) ---
        document.querySelectorAll(`.bulk-${type}`).forEach(inp => inp.value = "");
        if(type === 'penalti') document.getElementById('val-penalti').value = "";
        Object.keys(FORMULA_STORE).forEach(k => { if(k.startsWith(type)) delete FORMULA_STORE[k]; });
    } 
    else { showToast(res.message, 'error'); }
  } catch(e) { loader.style.display = 'none'; showToast("Ralat Sambungan!", 'error'); }
}

async function runAdmin(act) {
  const loader = document.getElementById('loader');
  const d = document.getElementById('date-hasil').value;
  loader.style.display = 'flex';
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: act, data: { peringkat: document.getElementById('sel-pkt-hasil').value, day: Number(d.split('-')[2]) } }) });
    const res = await r.json();
    loader.style.display = 'none';
    if(act === 'refreshRumusan' && res.tan !== undefined) {
      document.getElementById('display-tan-live').textContent = Number(res.tan).toFixed(2);
      FORMULA_STORE['hasil'] = String(res.tan); 
    }
    showToast(res.message, res.ok ? 'success' : 'error');
  } catch(e){ loader.style.display = 'none'; showToast("Ralat!", 'error'); }
}

async function fetchStats() {
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getHarvestStatus', data: {} }) });
    const res = await r.json();
    if(res.ok) { HARVEST_STATS = res.stats; updateStatsDisplay(document.getElementById('sel-pkt-hasil').value); }
  } catch(e){}
}

async function getReport(t) {
  const loader = document.getElementById('loader');
  loader.style.display = 'flex';
  const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'genReport', data: t }) });
  const res = await r.json();
  loader.style.display = 'none';
  if(res.ok) {
    document.getElementById('report-out').value = res.reportText;
    document.getElementById('reportResult').style.display = 'block';
  }
}

function copyText() { const t = document.getElementById('report-out'); t.select(); document.execCommand('copy'); showToast("Laporan disalin!", 'success'); }
</script>
</body>
</html>
