<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>e-HASIL FPMSB TENANG</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --bg-color: #f4f6f8; --card-bg: #ffffff; --text-main: #333333; --text-label: #555555;
      --border-color: #cccccc; --input-bg: #ffffff;
      --btn-blue: #007bff; --btn-green: #28a745; --btn-gray: #6c757d; --btn-purple: #6f42c1; --btn-red: #dc3545; --btn-orange: #fd7e14;
    }
    
    /* HIDE SCROLLBAR */
    ::-webkit-scrollbar { display: none; }
    * { -ms-overflow-style: none;  scrollbar-width: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: 'Roboto', sans-serif; 
      padding: 15px; background-color: var(--bg-color); color: var(--text-main); 
      margin: 0; min-height: 100vh; overscroll-behavior: none;
      display: flex; justify-content: center; padding-top: 70px;
    }

    .app-container { width: 100%; max-width: 480px; background: var(--bg-color); min-height: 100vh; position: relative; }

    /* HEADER & SIDEBAR */
    .header {
      position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: var(--btn-blue); color: white;
      display: flex; align-items: center; padding: 0 15px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .menu-btn { font-size: 28px; cursor: pointer; margin-right: 15px; }
    .header h3 { font-size: 18px; font-weight: 700; margin: 0; flex-grow: 1; }
    
    .sidebar {
      position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 1100;
      transition: 0.3s; box-shadow: 2px 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column;
    }
    .sidebar.open { left: 0; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: none; }
    .overlay.open { display: block; }
    
    .sb-header { height: 150px; background: var(--btn-blue); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .sb-menu { flex-grow: 1; padding: 10px 0; overflow-y: auto; }
    .sb-item { padding: 15px 20px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
    .sb-item i { margin-right: 15px; color: #777; }
    .sb-item.active { background: #e3f2fd; color: var(--btn-blue); font-weight: bold; }
    .sb-item.active i { color: var(--btn-blue); }

    /* CONTENT STYLES */
    .pill { display: block; width: fit-content; margin: 0 auto 20px auto; padding: 4px 12px; border-radius: 4px; background-color: #e2e6ea; color: #333; border: 1px solid #ccc; font-size: 11px; font-weight: bold; letter-spacing: 1px; }
    
    .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    label { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 12px; color: var(--text-label); margin-bottom: 5px; text-transform: uppercase; font-weight: 700; }
    label:first-child { margin-top: 0; }
    #luasDisplay { color: #155724; font-weight: bold; font-size: 12px; }

    select, input, textarea { width: 100%; padding: 12px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; font-size: 16px; color: #000; outline: none; font-family: 'Roboto', sans-serif; appearance: none; -webkit-appearance: none; }
    select:focus, input:focus { border-color: var(--btn-blue); background-color: #fff; }
    
    /* Disabled Input Style */
    input:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; border-color: #dee2e6; }

    /* BUTTONS */
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    button { width: 100%; padding: 14px; border: none; border-radius: 4px; font-family: 'Roboto', sans-serif; font-weight: bold; font-size: 14px; cursor: pointer; text-transform: uppercase; color: white; touch-action: manipulation; transition: all 0.2s; }
    button:active { opacity: 0.8; }
    
    /* BUTTON DISABLED STATE (LOCK) */
    button:disabled { 
        background-color: #cccccc !important; 
        color: #666666 !important; 
        cursor: not-allowed; 
        box-shadow: none;
    }
    
    .btn-primary { background-color: var(--btn-blue); }
    .btn-success { background-color: var(--btn-green); }
    .btn-secondary { background-color: var(--btn-gray); color: #fff; }
    .btn-special { background-color: var(--btn-purple); }
    .btn-red { background-color: var(--btn-red); }
    .btn-orange { background-color: var(--btn-orange); }

    .divider { display: flex; align-items: center; justify-content: center; margin: 25px 0 15px 0; position: relative; }
    .divider::before { content: ''; position: absolute; width: 100%; height: 1px; background-color: var(--border-color); }
    .sec-title { background-color: var(--bg-color); padding: 0 10px; font-size: 11px; color: #777; font-weight: bold; z-index: 1; }

    .msg-box { display: none; margin-top: 15px; padding: 10px; border-radius: 4px; text-align: center; font-size: 13px; font-weight: bold; }
    .msg-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .msg-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .msg-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

    /* STATUS BOX */
    .info-status { background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 10px; margin: 15px 0; display: none; justify-content: space-between; align-items: center; font-size: 12px; color: #155724; }
    .info-item { text-align: center; width: 45%; }
    .info-item b { display: block; font-size: 15px; margin-top: 2px; color: #000; }
    .info-divider { width: 1px; height: 35px; background-color: #9ccca6; opacity: 0.6; }
    .status-baki.done b { color: #28a745; } .status-baki b { color: #dc3545; }

    .report-area { margin-top: 15px; display: none; }
    textarea { font-family: monospace; font-size: 12px; background-color: #eee; color: #333; border: 1px solid #ccc; width:100%; }
    
    /* PAGES */
    .page-section { display: none; }
    .page-section.active { display: block; animation: fadein 0.3s; }
    @keyframes fadein { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    /* LOADER */
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; display: none; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--btn-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<div class="header">
  <i class="material-icons menu-btn" onclick="toggleMenu()">menu</i>
  <h3>FPMSB TENANG</h3>
  <div style="width:10px; height:10px; background:#00e676; border-radius:50%;" id="syncDot"></div>
</div>

<div class="overlay" onclick="toggleMenu()"></div>
<div class="sidebar">
  <div class="sb-header">
    <i class="material-icons" style="font-size:48px; margin-bottom:10px;">spa</i>
    <div style="font-weight:bold;">SISTEM LADANG</div>
  </div>
  <div class="sb-menu">
    <div class="sb-item active" onclick="nav('page-hasil', this)"><i class="material-icons">bar_chart</i>INPUT HASIL (TAN)</div>
    <div class="sb-item" onclick="nav('page-muda', this)"><i class="material-icons">eco</i>BTB MUDA</div>
    <div class="sb-item" onclick="nav('page-penalti', this)"><i class="material-icons">warning</i>PENALTI TANDAN</div>
    <div class="sb-item" onclick="nav('page-tandan', this)"><i class="material-icons">inventory_2</i>REKOD TANDAN</div>
    <div class="sb-item" onclick="nav('page-admin', this)"><i class="material-icons">admin_panel_settings</i>ADMIN & LAPORAN</div>
  </div>
</div>

<div class="app-container">

  <div id="page-hasil" class="page-section active">
    <div class="pill">MODE: HASIL</div>
    <div class="card">
      <div style="margin-bottom:15px; display:flex; gap:10px;">
        <input type="date" id="date-hasil" style="flex:1" onchange="renderPeringkatHasil()">
        <select id="mode-hasil" style="width:110px" onchange="renderPeringkatHasil()">
          <option value="TAN">TAN</option>
          <option value="PUS_TUAI">HEKTAR</option>
        </select>
      </div>

      <label>PERINGKAT <span id="info-luas" style="float:right; color:green;"></span></label>
      <select id="sel-pkt-hasil" onchange="renderTeamHasil()"></select>

      <div id="wrap-team-hasil" style="margin-top:15px;">
        <label id="lbl-team-hasil">TEAM / BLOK</label>
        <select id="sel-team-hasil" onchange="clearInput('Hasil')"></select>
      </div>

      <div id="box-status-tuai" class="info-status">
         <div class="info-item">SIAP <b id="valSiap">0.00</b></div>
         <div class="info-divider"></div>
         <div class="info-item">BAKI <b id="valBaki" style="color:#dc3545">0.00</b></div>
      </div>

      <div style="margin-top:15px;">
        <label id="lbl-val-hasil">NILAI (TAN)</label>
        <input type="text" id="val-hasil" placeholder="Contoh: =5.5+2.2" inputmode="decimal" style="font-size:24px; text-align:center; font-weight:bold;" oninput="checkInput('Hasil')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanHasil" class="btn-primary" onclick="saveData('hasil')" disabled>SIMPAN DATA</button>
      </div>
      
      <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
        <button id="btnRefRumusan" class="btn-secondary" onclick="runAdmin('refreshRumusan')" style="width:100%; display:none; margin-bottom:10px;">ðŸ”„ REFRESH RUMUSAN</button>
        <button id="btnSaveMaster" class="btn-success" onclick="runAdmin('saveMaster')" style="width:100%;">ðŸ“¥ SAVE MASTER (BULAN INI)</button>
      </div>

      <div id="msg-hasil" class="msg-box"></div>
    </div>
  </div>

  <div id="page-muda" class="page-section">
    <div class="pill">MODE: BTB MUDA</div>
    <div class="card">
      <div style="margin-bottom:15px;"><input type="date" id="date-muda"></div>
      
      <label>PERINGKAT (MUDA)</label>
      <select id="sel-pkt-muda" onchange="renderTeamMuda()">
        <option value="PKT001G">PKT 001G</option>
        <option value="PKT002">PKT 002</option>
        <option value="PKT003G">PKT 003G</option>
        <option value="PKT004A">PKT 004A</option>
      </select>

      <div style="margin-top:15px;">
        <label>TEAM / BLOK</label>
        <select id="sel-team-muda" onchange="clearInput('Muda')"></select>
      </div>

      <div style="margin-top:15px;">
        <label>BILANGAN TANDAN</label>
        <input type="number" id="val-muda" placeholder="0" style="font-size:24px; text-align:center; font-weight:bold;" oninput="checkInput('Muda')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanMuda" class="btn-green" onclick="saveData('muda')" disabled>SIMPAN BTB MUDA</button>
      </div>
      <div id="msg-muda" class="msg-box"></div>
    </div>
  </div>

  <div id="page-penalti" class="page-section">
    <div class="pill">MODE: PENALTI</div>
    <div class="card">
      <div style="margin-bottom:15px; display:flex; gap:10px;">
        <input type="date" id="date-penalti" style="flex:1">
        <select id="type-penalti" style="width:130px" onchange="clearInput('Penalti')">
          <option value="MENGKAL">MENGKAL</option>
          <option value="LAMA">LAMA</option>
        </select>
      </div>

      <label>PERINGKAT</label>
      <select id="sel-pkt-penalti" onchange="clearInput('Penalti')">
        <option value="PKT001">PKT 001</option>
        <option value="PKT001G">PKT 001G</option>
        <option value="PKT002">PKT 002</option>
        <option value="PKT003G">PKT 003G</option>
        <option value="PKT004">PKT 004</option>
      </select>

      <div style="margin-top:15px;">
        <label>BILANGAN TANDAN</label>
        <input type="number" id="val-penalti" placeholder="0" style="font-size:24px; text-align:center; font-weight:bold;" oninput="checkInput('Penalti')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanPenalti" class="btn-red" onclick="saveData('penalti')" disabled>SIMPAN PENALTI</button>
      </div>
      <div id="msg-penalti" class="msg-box"></div>
    </div>
  </div>

  <div id="page-tandan" class="page-section">
    <div class="pill">MODE: REKOD TANDAN</div>
    <div class="card">
      <div style="margin-bottom:15px;"><input type="date" id="date-tandan"></div>

      <label>PERINGKAT</label>
      <select id="sel-pkt-tandan" onchange="renderTeamTandan()">
        <option value="PKT004">PKT 004</option>
        <option value="PKT001">PKT 001</option>
        <option value="PKT002">PKT 002</option>
        <option value="PKT001G">PKT 001G</option>
        <option value="PKT003G">PKT 003G</option>
      </select>

      <div style="margin-top:15px;">
        <label>TEAM / BLOK</label>
        <select id="sel-team-tandan" onchange="clearInput('Tandan')"></select>
      </div>

      <div style="margin-top:15px;">
        <label>BILANGAN TANDAN (BIJI)</label>
        <input type="number" id="val-tandan" placeholder="0" style="font-size:24px; text-align:center; font-weight:bold;" oninput="checkInput('Tandan')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanTandan" class="btn-orange" onclick="saveData('tandan')" disabled>SIMPAN TANDAN</button>
      </div>
      <div id="msg-tandan" class="msg-box"></div>
    </div>
  </div>

  <div id="page-admin" class="page-section">
    <div class="pill">LAPORAN</div>
    <div class="card">
      <div class="divider"><span class="sec-title">JANA LAPORAN</span></div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn-primary" onclick="getReport('PO')">PO</button>
        <button class="btn-primary" onclick="getReport('RUMUSAN')">RUMUSAN</button>
      </div>
      <button class="btn-special" onclick="getReport('ALL')" style="width:100%; margin-top:10px;">JANA SEMUA LAPORAN</button>

      <div id="reportResult" class="report-area">
        <textarea id="report-out" rows="8" readonly onclick="this.select()"></textarea>
        <button class="btn-secondary" onclick="copyText()" style="width:100%; margin-top:10px;">ðŸ“‹ COPY TEKS</button>
      </div>
    </div>
  </div>

</div>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycby7bTjD0UGYgbpr8UluDRbwXz2_8RaOCkCzAWKkwxDNxLL3hPQU552D0Po-u9OgoQEieQ/exec"; 

// Data Configs
const HASIL_CFG = {
  pkt: ["PKT004","PKT001","PKT002","PKT001G","PKT003G","RUMUSAN"],
  teams: {
    PKT004: ["BLOK 1","BLOK 2","BLOK 3","BLOK 4","BLOK 5"],
    PKT002: ["TEAM PKT","TEAM 1","TEAM 2","TEAM TKA","TEAM TKA BAJA"],
    PKT001G:["HABIBI","P.BOWO","MEGA","TEAM TKA","TEAM TKA BAJA"],
    PKT003G:["TEAM KIRI","TEAM KANAN","TEAM BLOK C","TEAM TKA","TEAM TKA BAJA"]
  }
};

const MUDA_CFG = {
  "PKT001G": ["HABIBI", "P.BOWO", "MEGA", "TKA"],
  "PKT002":  ["TEAM PKT", "TEAM 1", "TEAM 2", "TKA"],
  "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"],
  "PKT004A": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"]
};

const TANDAN_CFG = {
  "PKT004":  ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"],
  "PKT001":  ["TKA"],
  "PKT002":  ["TEAM PKT", "TEAM 1", "TEAM 2"],
  "PKT001G": ["HABIBI", "P.BOWO", "MEGA"],
  "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"]
};

let HARVEST_STATS = null;

// --- INIT ---
window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  ['date-hasil','date-muda','date-penalti','date-tandan'].forEach(id => document.getElementById(id).value = today);

  renderPeringkatHasil();
  renderTeamMuda();
  renderTeamTandan();
  
  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  fetchStats();
};

// --- NAVIGATION ---
function toggleMenu() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.querySelector('.overlay').classList.toggle('open');
}
function nav(id, el) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  if(el) el.classList.add('active');
  toggleMenu();
}

// --- HELPER: AUTO CLEAR & LOCK BUTTON ---
function clearInput(type) {
    const el = document.getElementById('val-' + type.toLowerCase());
    if(el) {
        el.value = "";
        checkInput(type);
    }
}

function checkInput(type) {
    const val = document.getElementById('val-' + type.toLowerCase()).value;
    const btn = document.getElementById('btnSimpan' + type);
    if(btn) {
        btn.disabled = (val.trim() === "");
    }
}

// --- RENDER FUNCTIONS ---
function renderPeringkatHasil() {
  const mode = document.getElementById('mode-hasil').value;
  const sel = document.getElementById('sel-pkt-hasil');
  const list = (mode === "PUS_TUAI") ? HASIL_CFG.pkt.filter(x => x !== "RUMUSAN") : HASIL_CFG.pkt;
  
  sel.innerHTML = list.map(x => `<option>${x}</option>`).join("");
  document.getElementById('lbl-val-hasil').textContent = (mode==="TAN") ? "NILAI (TAN)" : "NILAI (HEKTAR)";
  
  renderTeamHasil();
  clearInput('Hasil'); 
}

function renderTeamHasil() {
  const p = document.getElementById('sel-pkt-hasil').value;
  const wrap = document.getElementById('wrap-team-hasil');
  const sel = document.getElementById('sel-team-hasil');
  const mode = document.getElementById('mode-hasil').value;

  const info = document.getElementById('info-luas');
  const box = document.getElementById('box-status-tuai');
  
  // LOGIC BUTTON VISIBILITY
  const btnRefRumusan = document.getElementById('btnRefRumusan');
  const btnSimpan = document.getElementById('btnSimpanHasil');
  const inpVal = document.getElementById('val-hasil');

  if(p === "RUMUSAN") {
      btnRefRumusan.style.display = "block"; 
      wrap.style.display = 'none'; 
      
      // LOCK INPUT FOR RUMUSAN
      inpVal.disabled = true;
      inpVal.style.backgroundColor = "#e9ecef";
      inpVal.placeholder = "Tekan Refresh ðŸ”„";
      btnSimpan.style.display = "none";
  } else {
      btnRefRumusan.style.display = "none";
      
      // UNLOCK FOR NORMAL
      inpVal.disabled = false;
      inpVal.style.backgroundColor = "#fff";
      inpVal.placeholder = "Contoh: =5.5+2.2";
      btnSimpan.style.display = "block";
      
      // RE-CHECK LOCK STATE FOR NORMAL
      checkInput('Hasil');

      if(p !== "PKT001") wrap.style.display = 'block'; else wrap.style.display = 'none';
  }

  // LOGIC STATUS BOX
  if(HARVEST_STATS && HARVEST_STATS[p]) {
     info.textContent = `â€¢ ${HARVEST_STATS[p].luas.toFixed(2)} Ha`;
     if(mode === "PUS_TUAI" && p !== "RUMUSAN") {
        box.style.display = 'flex';
        document.getElementById('valSiap').textContent = HARVEST_STATS[p].siap.toFixed(2);
        const d = Number(document.getElementById('date-hasil').value.split('-')[2]);
        let target = HARVEST_STATS[p].luas;
        if(d >= 16 || HARVEST_STATS[p].siap > HARVEST_STATS[p].luas) target *= 2;
        document.getElementById('valBaki').textContent = (target - HARVEST_STATS[p].siap).toFixed(2);
     } else box.style.display = 'none';
  } else {
     info.textContent = ""; box.style.display = 'none';
  }

  // DROPDOWN TEAM FILL
  if(p !== "RUMUSAN" && p !== "PKT001") {
    document.getElementById('lbl-team-hasil').textContent = (p==="PKT004") ? "BLOK" : "TEAM";
    const teams = HASIL_CFG.teams[p] || ["1","2","3","4","5"];
    sel.innerHTML = teams.map((t,i) => `<option value="${i}">${t}</option>`).join("");
  }
}

function renderTeamMuda() {
  const p = document.getElementById('sel-pkt-muda').value;
  const sel = document.getElementById('sel-team-muda');
  sel.innerHTML = (MUDA_CFG[p] || []).map(t => `<option value="${t}">${t}</option>`).join("");
  clearInput('Muda');
}

function renderTeamTandan() {
  const p = document.getElementById('sel-pkt-tandan').value;
  const sel = document.getElementById('sel-team-tandan');
  sel.innerHTML = (TANDAN_CFG[p] || []).map(t => `<option value="${t}">${t}</option>`).join("");
  clearInput('Tandan');
}

// --- SAVE HANDLER ---
async function saveData(type) {
  let action, payload = {};
  let msgEl = document.getElementById(`msg-${type}`);
  document.getElementById('loader').style.display = 'flex';

  if (type === 'hasil') {
    const mode = document.getElementById('mode-hasil').value;
    const val = document.getElementById('val-hasil').value;
    if(!val) { alert("Isi nilai!"); document.getElementById('loader').style.display='none'; return; }
    let fVal = (val.match(/[+\-*\/]/) && !val.startsWith('=')) ? "=" + val : val;
    payload = {
      peringkat: document.getElementById('sel-pkt-hasil').value,
      idx: document.getElementById('sel-team-hasil').value,
      day: Number(document.getElementById('date-hasil').value.split('-')[2]),
      fullDate: document.getElementById('date-hasil').value
    };
    if (mode === "TAN") { action = "saveTan"; payload.tan = fVal; } 
    else { action = "savePusTuai"; payload.tarikh = payload.fullDate; payload.hektar = fVal; }
  } 
  else if (type === 'muda') {
    action = "saveMuda";
    payload = {
      peringkat: document.getElementById('sel-pkt-muda').value,
      teamName: document.getElementById('sel-team-muda').value,
      val: document.getElementById('val-muda').value,
      tarikh: document.getElementById('date-muda').value
    };
  } 
  else if (type === 'penalti') {
    action = "savePenalti";
    payload = {
      type: document.getElementById('type-penalti').value,
      peringkat: document.getElementById('sel-pkt-penalti').value,
      val: document.getElementById('val-penalti').value,
      tarikh: document.getElementById('date-penalti').value
    };
  }
  else if (type === 'tandan') {
    action = "saveTandan";
    payload = {
      peringkat: document.getElementById('sel-pkt-tandan').value,
      teamName: document.getElementById('sel-team-tandan').value,
      val: document.getElementById('val-tandan').value,
      tarikh: document.getElementById('date-tandan').value
    };
  }

  if(!payload.val && type !== 'hasil') { alert("Isi nilai!"); document.getElementById('loader').style.display='none'; return; }

  try {
    const req = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data: payload }) });
    const res = await req.json();
    document.getElementById('loader').style.display = 'none';
    if(res.ok) {
      showMsg(msgEl, res.message, true);
      clearInput(type.charAt(0).toUpperCase() + type.slice(1)); // Auto Clear after save
      if(type==='hasil' && document.getElementById('mode-hasil').value==="PUS_TUAI") fetchStats();
    } else showMsg(msgEl, res.message, false);
  } catch(e) {
    document.getElementById('loader').style.display = 'none';
    showMsg(msgEl, "Ralat Sambungan!", false);
  }
}

// --- HELPERS ---
async function fetchStats() {
  try {
    const req = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getHarvestStatus', data: {} }) });
    const res = await req.json();
    if(res.ok) { HARVEST_STATS = res.stats; renderTeamHasil(); }
  } catch(e){}
}

async function runAdmin(act) {
  if(act !== 'refreshRumusan' && !confirm("Anda pasti?")) return;
  
  document.getElementById('loader').style.display = 'flex';
  const d = document.getElementById('date-hasil').value;
  const p = document.getElementById('sel-pkt-hasil').value;
  
  try {
      const req = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: act, data: { peringkat: p, fullDate: d, day: Number(d.split('-')[2]) } }) });
      const res = await req.json();
      document.getElementById('loader').style.display = 'none';
      if(res.ok) {
          if(act === 'refreshRumusan' && res.tan) document.getElementById('val-hasil').value = Number(res.tan).toFixed(2);
          showMsg(document.getElementById('msg-hasil'), res.message || "Selesai", true);
      } else alert("Gagal: " + res.message);
  } catch(e) {
      document.getElementById('loader').style.display = 'none';
      alert("Error Sambungan.");
  }
}

async function getReport(t) {
  document.getElementById('loader').style.display = 'flex';
  const req = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'genReport', data: t }) });
  const res = await req.json();
  document.getElementById('loader').style.display = 'none';
  if(res.ok) {
    document.getElementById('report-out').value = res.reportText;
    document.getElementById('reportResult').style.display = 'block';
  }
}

function copyText() {
  const t = document.getElementById('report-out');
  t.select(); document.execCommand('copy');
  alert("Teks Disalin!");
}

function showMsg(el, txt, success) {
  el.textContent = txt;
  el.className = "msg-box " + (success ? "msg-success" : "msg-error");
  el.style.display = "block";
  setTimeout(()=>el.style.display="none", 3000);
}
</script>
</body>
</html>
