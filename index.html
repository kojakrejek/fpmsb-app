<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4a90e2">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>e-HASIL FPMSB TENANG</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --primary: #4a90e2; --primary-dark: #0056b3;
      --accent: #50e3c2; 
      --bg-body: #f0f2f5; --bg-card: #ffffff;
      --text-main: #2c3e50; --text-muted: #95a5a6;
      --shadow: 0 4px 15px rgba(0,0,0,0.05);
      --radius: 12px;
      --success: #2ecc71; --warning: #f1c40f; --danger: #e74c3c; --info: #3498db;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { display: none; }

    body { 
      font-family: 'Poppins', sans-serif; 
      background-color: var(--bg-body); color: var(--text-main); 
      margin: 0; min-height: 100vh; padding-top: 70px;
      display: flex; justify-content: center;
    }

    .app-container { width: 100%; max-width: 480px; padding: 15px; }

    .header {
      position: fixed; top: 0; left: 0; width: 100%; height: 65px;
      background: linear-gradient(135deg, #4a90e2, #9013fe); 
      color: white; display: flex; align-items: center; padding: 0 20px;
      z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
    }
    .menu-btn { font-size: 28px; cursor: pointer; margin-right: 15px; }
    .header h3 { font-size: 18px; font-weight: 600; margin: 0; flex-grow: 1; letter-spacing: 0.5px; }
    .sync-dot { width: 10px; height: 10px; background: #50e3c2; border-radius: 50%; box-shadow: 0 0 5px #50e3c2; }

    .sidebar {
      position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
      background: white; z-index: 1100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 4px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;
    }
    .sidebar.open { left: 0; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1050; display: none; backdrop-filter: blur(2px); }
    .overlay.open { display: block; }
    
    .sb-header { 
      height: 160px; background: linear-gradient(135deg, #4a90e2, #9013fe); 
      color: white; display: flex; flex-direction: column; 
      justify-content: center; align-items: center; 
    }
    .sb-logo-text { font-size: 18px; font-weight: 700; margin-top: 10px; letter-spacing: 1px; }
    
    .sb-menu { flex-grow: 1; padding: 15px 0; overflow-y: auto; }
    .sb-item { 
      padding: 15px 25px; display: flex; align-items: center; 
      color: #555; font-weight: 500; transition: 0.2s; border-left: 4px solid transparent;
    }
    .sb-item i { margin-right: 15px; color: #999; font-size: 22px; }
    .sb-item.active { background: #f0f7ff; color: var(--primary); border-left-color: var(--primary); }
    .sb-item.active i { color: var(--primary); }

    .card { 
      background: var(--bg-card); border-radius: var(--radius); 
      padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); 
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .pill { 
      background: #eef2f7; color: #555; padding: 6px 15px; 
      border-radius: 20px; font-size: 11px; font-weight: 700; 
      letter-spacing: 1px; width: fit-content; margin: 0 auto 15px auto; 
      text-transform: uppercase; display: block;
    }

    .input-group { margin-bottom: 15px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #7f8c8d; margin-bottom: 6px; text-transform: uppercase; }
    .input-wrapper { position: relative; }
    .input-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #bdc3c7; }
    
    select, input, textarea { 
      width: 100%; padding: 12px 15px 12px 40px; 
      border: 2px solid #ecf0f1; border-radius: 10px; 
      font-size: 15px; font-family: 'Poppins', sans-serif; color: #333;
      transition: 0.3s; background: #fff; appearance: none;
    }
    select:focus, input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
    
    .big-input { 
      font-size: 24px !important; font-weight: 700; text-align: center; 
      padding-left: 15px !important; color: var(--primary);
    }

    button { 
      width: 100%; padding: 14px; border: none; border-radius: 10px; 
      font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 14px; 
      text-transform: uppercase; cursor: pointer; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    button:active { transform: scale(0.98); }
    
    .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    .btn-primary { background: linear-gradient(135deg, #4a90e2, #357abd); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #fff; }
    .btn-secondary { background: #fff; border: 2px solid #ecf0f1; color: #555; box-shadow: none; }

    .info-status { 
      background: #e8f8f5; border: 1px solid #d1f2eb; border-radius: 10px; 
      padding: 12px; margin: 20px 0; display: flex; justify-content: space-between; 
      align-items: center;
    }
    .info-item { text-align: center; width: 45%; }
    .info-item span { font-size: 11px; color: #16a085; font-weight: 600; }
    .info-item b { display: block; font-size: 16px; color: #0e6655; margin-top: 2px; }
    .info-divider { width: 1px; height: 30px; background: #d1f2eb; }

    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; display: none; backdrop-filter: blur(5px); }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .page-section { display: none; animation: slideUp 0.3s ease-out; }
    .page-section.active { display: block; }
    @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

    .bulk-row {
      display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
      padding: 10px; background: #f8f9fa; border-radius: 8px;
    }
    .bulk-row label { flex: 1; margin: 0; color: #333; font-size: 13px; }
    .bulk-row input { flex: 1; padding: 8px; padding-left: 10px; text-align: right; }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top:15px; font-size:12px; font-weight:600; color:#555;">SILA TUNGGU...</div>
</div>

<div class="header">
  <i class="material-icons menu-btn" onclick="toggleMenu()">menu</i>
  <h3>e-HASIL TENANG</h3>
  <div class="sync-dot" id="syncDot"></div>
</div>

<div class="overlay" onclick="toggleMenu()"></div>
<div class="sidebar">
  <div class="sb-header">
    <i class="material-icons" style="font-size:50px; margin-bottom:10px;">spa</i>
    <div class="sb-logo-text">SISTEM LADANG</div>
  </div>
  <div class="sb-menu">
    <div class="sb-item active" onclick="nav('page-hasil', this)"><i class="material-icons">bar_chart</i>INPUT HASIL</div>
    <div class="sb-item" onclick="nav('page-muda', this)"><i class="material-icons">eco</i>BTB MUDA</div>
    <div class="sb-item" onclick="nav('page-penalti', this)"><i class="material-icons">warning</i>PENALTI</div>
    <div class="sb-item" onclick="nav('page-tandan', this)"><i class="material-icons">inventory_2</i>REKOD TANDAN</div>
    <div class="sb-item" onclick="nav('page-admin', this)"><i class="material-icons">settings</i>ADMIN & REPORT</div>
  </div>
</div>

<div class="app-container">

  <div id="page-hasil" class="page-section active">
    <div class="pill">MODE: HASIL</div>
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div class="input-wrapper" style="flex:1"><i class="material-icons">calendar_today</i><input type="date" id="date-hasil" onchange="renderPeringkatHasil()"></div>
        <div class="input-wrapper" style="width:120px"><i class="material-icons">tune</i><select id="mode-hasil" onchange="renderPeringkatHasil()"><option value="TAN">TAN</option><option value="PUS_TUAI">HEKTAR</option></select></div>
      </div>

      <div class="input-group">
        <label>PERINGKAT <span id="info-luas" style="float:right; color:var(--success);"></span></label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-hasil" onchange="renderTeamHasil()"></select></div>
      </div>

      <div id="wrap-team-hasil" style="margin-top:15px;"></div>

      <div id="box-status-tuai" class="info-status" style="display:none;">
         <div class="info-item"><span>SIAP TUAI</span><b id="valSiap">0.00</b></div>
         <div class="info-divider"></div>
         <div class="info-item status-baki"><span>BAKI LUAS</span><b id="valBaki" style="color:var(--danger)">0.00</b></div>
      </div>

      <div id="wrap-single-hasil" class="input-group" style="margin-top:20px; display:none;">
        <label id="lbl-val-hasil">NILAI</label>
        <input type="text" id="val-hasil" class="big-input" placeholder="0.00" inputmode="text"
               onfocus="onFocusInput('hasil')" onblur="onBlurInput('hasil')" oninput="onInputHandler('hasil')">
      </div>

      <div style="margin-top:25px; border-top:1px dashed #ddd; padding-top:20px;">
        <button id="btnRefRumusan" class="btn-secondary" onclick="runAdmin('refreshRumusan')" style="display:none; margin-bottom:10px; width:100%"><i class="material-icons">sync</i> REFRESH RUMUSAN</button>
        <button class="btn-success" onclick="processSaveMaster()" style="width:100%">
          <i class="material-icons">cloud_upload</i> SAVE MASTER (FORCE)
        </button>
      </div>
    </div>
  </div>

  <div id="page-muda" class="page-section">
    <div class="pill">MODE: BTB MUDA</div>
    <div class="card">
      <div class="input-group"><div class="input-wrapper"><i class="material-icons">calendar_today</i><input type="date" id="date-muda"></div></div>
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-muda" onchange="renderTeamMuda()"><option value="PKT001G">PKT 001G</option><option value="PKT002">PKT 002</option><option value="PKT003G">PKT 003G</option><option value="PKT004A">PKT 004A</option></select></div>
      </div>
      <div id="wrap-team-muda" style="margin-top:15px;"></div>
      <div class="btn-group">
        <button class="btn-success" onclick="saveData('muda')"><i class="material-icons">check_circle</i> SIMPAN MUDA</button>
      </div>
    </div>
  </div>

  <div id="page-penalti" class="page-section">
    <div class="pill">MODE: PENALTI</div>
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div class="input-wrapper" style="flex:1"><i class="material-icons">calendar_today</i><input type="date" id="date-penalti"></div>
        <div class="input-wrapper" style="width:130px"><i class="material-icons">category</i><select id="type-penalti"><option value="MENGKAL">MENGKAL</option><option value="LAMA">LAMA</option></select></div>
      </div>
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-penalti"><option value="PKT001">PKT 001</option><option value="PKT001G">PKT 001G</option><option value="PKT002">PKT 002</option><option value="PKT003G">PKT 003G</option><option value="PKT004">PKT 004</option></select></div>
      </div>
      <div class="input-group" style="margin-top:20px;">
        <label>BILANGAN TANDAN</label>
        <input type="text" id="val-penalti" class="big-input" placeholder="0" inputmode="text"
               onfocus="onFocusInput('penalti')" onblur="onBlurInput('penalti')" oninput="onInputHandler('penalti')">
      </div>
      <div class="btn-group">
        <button class="btn-danger" onclick="saveData('penalti')"><i class="material-icons">error_outline</i> SIMPAN PENALTI</button>
      </div>
    </div>
  </div>

  <div id="page-tandan" class="page-section">
    <div class="pill">MODE: REKOD TANDAN</div>
    <div class="card">
      <div class="input-group"><div class="input-wrapper"><i class="material-icons">calendar_today</i><input type="date" id="date-tandan"></div></div>
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-tandan" onchange="renderTeamTandan()"><option value="PKT004">PKT 004</option><option value="PKT001">PKT 001</option><option value="PKT002">PKT 002</option><option value="PKT001G">PKT 001G</option><option value="PKT003G">PKT 003G</option></select></div>
      </div>
      <div id="wrap-team-tandan" style="margin-top:15px;"></div>
      <div class="btn-group">
        <button class="btn-warning" onclick="saveData('tandan')"><i class="material-icons">inventory_2</i> SIMPAN TANDAN</button>
      </div>
    </div>
  </div>

  <div id="page-admin" class="page-section">
    <div class="pill">ADMIN & LAPORAN</div>
    <div class="card">
      <label>JANA LAPORAN HARIAN</label>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn-secondary" onclick="getReport('PO')">PO</button>
        <button class="btn-secondary" onclick="getReport('RUMUSAN')">RUMUSAN</button>
      </div>
      <button class="btn-primary" onclick="getReport('ALL')" style="margin-top:15px; width:100%"><i class="material-icons">description</i> JANA SEMUA</button>
      <div id="reportResult" style="margin-top:15px; display:none;">
        <textarea id="report-out" style="width:100%; height:200px; padding:10px; border-radius:8px;" readonly></textarea>
        <button class="btn-success" onclick="copyText()" style="margin-top:10px; width:100%"><i class="material-icons">content_copy</i> SALIN TEKS</button>
      </div>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwH9NrkZCZ6MOVczxSrcJFOnIenf3IyIm4R1NX8VC-_ZOQoipPrEE2mT7eu7oLe24y7BQ/exec"; 

const HASIL_CFG = { pkt: ["PKT004","PKT001","PKT002","PKT001G","PKT003G","RUMUSAN"], teams: { PKT004: ["BLOK 1","BLOK 2","BLOK 3","BLOK 4","BLOK 5"], PKT002: ["TEAM PKT","TEAM 1","TEAM 2","TEAM TKA","TEAM TKA BAJA"], PKT001G:["HABIBI","P.BOWO","MEGA","TEAM TKA","TEAM TKA BAJA"], PKT003G:["TEAM KIRI","TEAM KANAN","TEAM BLOK C","TEAM TKA","TEAM TKA BAJA"] } };
const MUDA_CFG = { "PKT001G": ["HABIBI", "P.BOWO", "MEGA", "TKA"], "PKT002": ["TEAM PKT", "TEAM 1", "TEAM 2", "TKA"], "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"], "PKT004A": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"] };
const TANDAN_CFG = { "PKT004": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"], "PKT001": ["TKA"], "PKT002": ["TEAM PKT", "TEAM 1", "TEAM 2"], "PKT001G": ["HABIBI", "P.BOWO", "MEGA"], "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"] };

let HARVEST_STATS = null;
let FORMULA_STORE = {}; 

window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  ['date-hasil','date-muda','date-penalti','date-tandan'].forEach(id => document.getElementById(id).value = today);
  renderPeringkatHasil(); renderTeamMuda(); renderTeamTandan();
  fetchStats();
};

function toggleMenu() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('open'); }
function nav(id, el) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  if(el) el.classList.add('active');
  toggleMenu();
}

// ==========================================
// SMART FORMULA ENGINE (FOR BULK & SINGLE)
// ==========================================
function onInputHandler(id, type) {
  const el = (id instanceof HTMLElement) ? id : document.getElementById(id);
  const key = type + (el.dataset.idx || el.dataset.team || "");
  FORMULA_STORE[key] = el.value;
}

function onBlurInput(id, type) {
  const el = (id instanceof HTMLElement) ? id : document.getElementById(id);
  const key = type + (el.dataset.idx || el.dataset.team || "");
  let val = el.value.trim();
  if(!val) { FORMULA_STORE[key] = ""; return; }

  if (val.match(/[+\-*\/]/) && !val.startsWith('=')) {
    val = "=" + val;
    FORMULA_STORE[key] = val;
  }

  if (val.startsWith('=')) {
    try {
      let result = Function('"use strict";return (' + val.substring(1) + ')')();
      if (!isNaN(result)) el.value = (result % 1 !== 0) ? result.toFixed(2) : result;
    } catch(e) {}
  }
}

function onFocusInput(id, type) {
  const el = (id instanceof HTMLElement) ? id : document.getElementById(id);
  const key = type + (el.dataset.idx || el.dataset.team || "");
  if (FORMULA_STORE[key] && FORMULA_STORE[key].startsWith('=')) el.value = FORMULA_STORE[key];
}

// --- RENDER LOGIC ---

function renderPeringkatHasil() {
  const sel = document.getElementById('sel-pkt-hasil');
  const mode = document.getElementById('mode-hasil').value;
  const list = (mode === "PUS_TUAI") ? HASIL_CFG.pkt.filter(x => x !== "RUMUSAN") : HASIL_CFG.pkt;
  sel.innerHTML = list.map(x => `<option value="${x}">${x}</option>`).join("");
  renderTeamHasil();
}

function renderTeamHasil() {
  const p = document.getElementById('sel-pkt-hasil').value;
  const mode = document.getElementById('mode-hasil').value;
  const wrap = document.getElementById('wrap-team-hasil');
  const wrapSingle = document.getElementById('wrap-single-hasil');
  
  if(p === "RUMUSAN") {
    alert("ðŸ“¢ NOTA: Sila klik 'REFRESH RUMUSAN' dahulu!");
    document.getElementById('btnRefRumusan').style.display = 'block';
    wrap.innerHTML = ""; wrapSingle.style.display = 'none';
    return;
  }
  document.getElementById('btnRefRumusan').style.display = 'none';

  if(mode === "TAN") {
    wrapSingle.style.display = 'none';
    let teams = (p === "PKT001") ? ["TOTAL"] : (HASIL_CFG.teams[p] || []);
    let html = `<label>MASUKKAN TAN PER TEAM (${p})</label>`;
    teams.forEach((t, i) => {
      html += `<div class="bulk-row">
                <label>${t}</label>
                <input type="text" class="bulk-hasil" data-idx="${i}" placeholder="0.00" 
                       onfocus="onFocusInput(this,'hasil')" onblur="onBlurInput(this,'hasil')" oninput="onInputHandler(this,'hasil')">
               </div>`;
    });
    wrap.innerHTML = html;
  } else {
    wrap.innerHTML = ""; wrapSingle.style.display = 'block';
  }
  updateStatsDisplay(p);
}

function renderTeamMuda() {
  const p = document.getElementById('sel-pkt-muda').value;
  const wrap = document.getElementById('wrap-team-muda');
  let html = `<label>SENARAI TEAM : ${p}</label>`;
  (MUDA_CFG[p] || []).forEach(t => {
    html += `<div class="bulk-row">
              <label>${t}</label>
              <input type="text" class="bulk-muda" data-team="${t}" placeholder="0" 
                     onfocus="onFocusInput(this,'muda')" onblur="onBlurInput(this,'muda')" oninput="onInputHandler(this,'muda')">
             </div>`;
  });
  wrap.innerHTML = html;
}

function renderTeamTandan() {
  const p = document.getElementById('sel-pkt-tandan').value;
  const wrap = document.getElementById('wrap-team-tandan');
  let html = `<label>SENARAI TEAM : ${p}</label>`;
  (TANDAN_CFG[p] || []).forEach(t => {
    html += `<div class="bulk-row">
              <label>${t}</label>
              <input type="text" class="bulk-tandan" data-team="${t}" placeholder="0" 
                     onfocus="onFocusInput(this,'tandan')" onblur="onBlurInput(this,'tandan')" oninput="onInputHandler(this,'tandan')">
             </div>`;
  });
  wrap.innerHTML = html;
}

function updateStatsDisplay(p) {
  const box = document.getElementById('box-status-tuai');
  const info = document.getElementById('info-luas');
  if(HARVEST_STATS && HARVEST_STATS[p]) {
    info.textContent = `â€¢ ${HARVEST_STATS[p].luas.toFixed(2)} Ha`;
    if(document.getElementById('mode-hasil').value === "PUS_TUAI") {
      box.style.display = 'flex';
      document.getElementById('valSiap').textContent = HARVEST_STATS[p].siap.toFixed(2);
      document.getElementById('valBaki').textContent = (HARVEST_STATS[p].luas - HARVEST_STATS[p].siap).toFixed(2);
    } else box.style.display = 'none';
  } else { info.textContent = ""; box.style.display = 'none'; }
}

// --- SAVE LOGIC ---

async function processSaveMaster() {
  const loader = document.getElementById('loader');
  const fullDate = document.getElementById(`date-hasil`).value;
  const pkt = document.getElementById(`sel-pkt-hasil`).value;
  const mode = document.getElementById('mode-hasil').value;
  
  let payload = { peringkat: pkt, tarikh: fullDate, day: Number(fullDate.split('-')[2]) };
  let action = "";

  if(mode === "TAN") {
    action = "saveTanBulk"; payload.list = [];
    document.querySelectorAll('.bulk-hasil').forEach(inp => {
      let val = FORMULA_STORE['hasil' + inp.dataset.idx] || inp.value;
      if(val.trim() !== "") payload.list.push({ idx: inp.dataset.idx, val: val });
    });
  } else {
    action = "savePusTuai"; payload.hektar = FORMULA_STORE['hasil'] || document.getElementById('val-hasil').value;
  }

  loader.style.display = 'flex';
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data: payload }) });
    const res = await r.json();
    loader.style.display = 'none';
    alert(res.message);
    if(res.ok && mode === "PUS_TUAI") fetchStats();
  } catch(e) { loader.style.display = 'none'; alert("Error!"); }
}

async function saveData(type) {
  const loader = document.getElementById('loader');
  const fullDate = document.getElementById(`date-${type}`).value;
  const pkt = document.getElementById(`sel-pkt-${type}`).value;
  
  let payload = { peringkat: pkt, tarikh: fullDate, day: Number(fullDate.split('-')[2]) };
  let action = (type === 'muda') ? "saveMudaBulk" : (type === 'tandan' ? "saveTandanBulk" : "savePenalti");
  payload.list = [];

  if(type === 'penalti') {
    payload.type = document.getElementById('type-penalti').value;
    payload.val = FORMULA_STORE['penalti'] || document.getElementById('val-penalti').value;
  } else {
    document.querySelectorAll(`.bulk-${type}`).forEach(inp => {
      let val = FORMULA_STORE[type + (inp.dataset.team || "")] || inp.value;
      if(val.trim() !== "") payload.list.push({ team: inp.dataset.team, val: val });
    });
  }

  loader.style.display = 'flex';
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data: payload }) });
    const res = await r.json();
    loader.style.display = 'none';
    alert(res.message);
  } catch(e) { loader.style.display = 'none'; alert("Error!"); }
}

async function fetchStats() {
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getHarvestStatus', data: {} }) });
    const res = await r.json();
    if(res.ok) { HARVEST_STATS = res.stats; updateStatsDisplay(document.getElementById('sel-pkt-hasil').value); }
  } catch(e){}
}

async function runAdmin(act) {
  const loader = document.getElementById('loader');
  const d = document.getElementById('date-hasil').value;
  loader.style.display = 'flex';
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: act, data: { peringkat: document.getElementById('sel-pkt-hasil').value, day: Number(d.split('-')[2]) } }) });
    const res = await r.json();
    loader.style.display = 'none';
    alert(res.message);
  } catch(e){ loader.style.display = 'none'; alert("Error!"); }
}

async function getReport(t) {
  const loader = document.getElementById('loader');
  loader.style.display = 'flex';
  const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'genReport', data: t }) });
  const res = await r.json();
  loader.style.display = 'none';
  if(res.ok) {
    document.getElementById('report-out').value = res.reportText;
    document.getElementById('reportResult').style.display = 'block';
  }
}

function copyText() { const t = document.getElementById('report-out'); t.select(); document.execCommand('copy'); alert("Disalin!"); }
</script>
</body>
</html>
