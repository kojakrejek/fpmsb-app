<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4a90e2">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>e-HASIL FPMSB TENANG</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --primary: #4a90e2; --primary-dark: #0056b3;
      --accent: #50e3c2; 
      --bg-body: #f0f2f5; --bg-card: #ffffff;
      --text-main: #2c3e50; --text-muted: #95a5a6;
      --shadow: 0 4px 15px rgba(0,0,0,0.05);
      --radius: 12px;
      /* Status Colors */
      --success: #2ecc71; --warning: #f1c40f; --danger: #e74c3c; --info: #3498db;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { display: none; }

    body { 
      font-family: 'Poppins', sans-serif; 
      background-color: var(--bg-body); color: var(--text-main); 
      margin: 0; min-height: 100vh; padding-top: 70px;
      display: flex; justify-content: center;
    }

    .app-container { width: 100%; max-width: 480px; padding: 15px; }

    /* --- HEADER --- */
    .header {
      position: fixed; top: 0; left: 0; width: 100%; height: 65px;
      background: linear-gradient(135deg, #4a90e2, #9013fe); 
      color: white; display: flex; align-items: center; padding: 0 20px;
      z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
    }
    .menu-btn { font-size: 28px; cursor: pointer; margin-right: 15px; }
    .header h3 { font-size: 18px; font-weight: 600; margin: 0; flex-grow: 1; letter-spacing: 0.5px; }
    .sync-dot { width: 10px; height: 10px; background: #50e3c2; border-radius: 50%; box-shadow: 0 0 5px #50e3c2; }

    /* --- SIDEBAR --- */
    .sidebar {
      position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
      background: white; z-index: 1100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 4px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;
    }
    .sidebar.open { left: 0; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1050; display: none; backdrop-filter: blur(2px); }
    .overlay.open { display: block; }
    
    .sb-header { 
      height: 160px; background: linear-gradient(135deg, #4a90e2, #9013fe); 
      color: white; display: flex; flex-direction: column; 
      justify-content: center; align-items: center; 
    }
    .sb-logo-text { font-size: 18px; font-weight: 700; margin-top: 10px; letter-spacing: 1px; }
    
    .sb-menu { flex-grow: 1; padding: 15px 0; overflow-y: auto; }
    .sb-item { 
      padding: 15px 25px; display: flex; align-items: center; 
      color: #555; font-weight: 500; transition: 0.2s; border-left: 4px solid transparent;
    }
    .sb-item i { margin-right: 15px; color: #999; font-size: 22px; }
    .sb-item.active { background: #f0f7ff; color: var(--primary); border-left-color: var(--primary); }
    .sb-item.active i { color: var(--primary); }

    /* --- CARDS & UI --- */
    .card { 
      background: var(--bg-card); border-radius: var(--radius); 
      padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); 
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .pill { 
      background: #eef2f7; color: #555; padding: 6px 15px; 
      border-radius: 20px; font-size: 11px; font-weight: 700; 
      letter-spacing: 1px; width: fit-content; margin: 0 auto 15px auto; 
      text-transform: uppercase; display: block;
    }

    /* --- INPUTS --- */
    .input-group { margin-bottom: 15px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #7f8c8d; margin-bottom: 6px; text-transform: uppercase; }
    .input-wrapper { position: relative; }
    .input-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #bdc3c7; }
    
    select, input, textarea { 
      width: 100%; padding: 12px 15px 12px 40px; 
      border: 2px solid #ecf0f1; border-radius: 10px; 
      font-size: 15px; font-family: 'Poppins', sans-serif; color: #333;
      transition: 0.3s; background: #fff; appearance: none;
    }
    select:focus, input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
    input:disabled { background: #f8f9fa; border-color: #eee; color: #aaa; cursor: not-allowed; }

    /* SPECIAL INPUT (BIG NUMBER) */
    .big-input { 
      font-size: 26px !important; font-weight: 700; text-align: center; 
      padding-left: 15px !important; letter-spacing: 1px; color: var(--primary);
    }

    /* --- BUTTONS --- */
    .btn-group { display: flex; gap: 10px; margin-top: 25px; }
    button { 
      width: 100%; padding: 14px; border: none; border-radius: 10px; 
      font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 14px; 
      text-transform: uppercase; cursor: pointer; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    button:active { transform: scale(0.98); }
    button:disabled { background: #dcdde1 !important; color: #95a5a6 !important; box-shadow: none; cursor: not-allowed; }

    .btn-primary { background: linear-gradient(135deg, #4a90e2, #357abd); color: white; }
    .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #fff; }
    .btn-secondary { background: #fff; border: 2px solid #ecf0f1; color: #555; box-shadow: none; }

    /* --- INFO BOX --- */
    .info-status { 
      background: #e8f8f5; border: 1px solid #d1f2eb; border-radius: 10px; 
      padding: 12px; margin: 20px 0; display: flex; justify-content: space-between; 
      align-items: center;
    }
    .info-item { text-align: center; width: 45%; }
    .info-item span { font-size: 11px; color: #16a085; font-weight: 600; }
    .info-item b { display: block; font-size: 16px; color: #0e6655; margin-top: 2px; }
    .info-divider { width: 1px; height: 30px; background: #d1f2eb; }
    .status-baki b { color: var(--danger); }

    /* --- ALERTS --- */
    .msg-box { 
      display: none; margin-top: 15px; padding: 12px; border-radius: 8px; 
      text-align: center; font-size: 13px; font-weight: 600; 
    }
    .msg-success { background: #d4edda; color: #155724; }
    .msg-error { background: #f8d7da; color: #721c24; }

    /* LOADER */
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; display: none; backdrop-filter: blur(5px); }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .page-section { display: none; animation: slideUp 0.3s ease-out; }
    .page-section.active { display: block; }
    @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top:15px; font-size:12px; font-weight:600; color:#555;">SILA TUNGGU...</div>
</div>

<div class="header">
  <i class="material-icons menu-btn" onclick="toggleMenu()">menu</i>
  <h3>e-HASIL TENANG</h3>
  <div class="sync-dot" id="syncDot"></div>
</div>

<div class="overlay" onclick="toggleMenu()"></div>
<div class="sidebar">
  <div class="sb-header">
    <i class="material-icons" style="font-size:50px; margin-bottom:10px;">spa</i>
    <div class="sb-logo-text">SISTEM LADANG</div>
  </div>
  <div class="sb-menu">
    <div class="sb-item active" onclick="nav('page-hasil', this)"><i class="material-icons">bar_chart</i>INPUT HASIL</div>
    <div class="sb-item" onclick="nav('page-muda', this)"><i class="material-icons">eco</i>BTB MUDA</div>
    <div class="sb-item" onclick="nav('page-penalti', this)"><i class="material-icons">warning</i>PENALTI</div>
    <div class="sb-item" onclick="nav('page-tandan', this)"><i class="material-icons">inventory_2</i>REKOD TANDAN</div>
    <div class="sb-item" onclick="nav('page-admin', this)"><i class="material-icons">settings</i>ADMIN & REPORT</div>
  </div>
</div>

<div class="app-container">

  <div id="page-hasil" class="page-section active">
    <div class="pill">MODE: HASIL</div>
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div class="input-wrapper" style="flex:1"><i class="material-icons">calendar_today</i><input type="date" id="date-hasil" onchange="renderPeringkatHasil()"></div>
        <div class="input-wrapper" style="width:120px"><i class="material-icons">tune</i><select id="mode-hasil" onchange="renderPeringkatHasil()"><option value="TAN">TAN</option><option value="PUS_TUAI">HEKTAR</option></select></div>
      </div>

      <div class="input-group">
        <label>PERINGKAT <span id="info-luas" style="float:right; color:var(--success);"></span></label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-hasil" onchange="renderTeamHasil()"></select></div>
      </div>

      <div class="input-group" id="wrap-team-hasil">
        <label id="lbl-team-hasil">TEAM / BLOK</label>
        <div class="input-wrapper"><i class="material-icons">groups</i><select id="sel-team-hasil" onchange="clearInput('hasil')"></select></div>
      </div>

      <div id="box-status-tuai" class="info-status" style="display:none;">
         <div class="info-item"><span>SIAP TUAI</span><b id="valSiap">0.00</b></div>
         <div class="info-divider"></div>
         <div class="info-item status-baki"><span>BAKI LUAS</span><b id="valBaki" style="color:var(--danger)">0.00</b></div>
      </div>

      <div class="input-group" style="margin-top:20px;">
        <label id="lbl-val-hasil">NILAI (TAN)</label>
        <input type="text" id="val-hasil" class="big-input" placeholder="0.00" inputmode="text" 
               onfocus="onFocusInput('hasil')" onblur="onBlurInput('hasil')" oninput="onInputHandler('hasil')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanhasil" class="btn-primary" onclick="saveData('hasil')" disabled><i class="material-icons">save</i> SIMPAN DATA</button>
      </div>

      <div style="margin-top:25px; border-top:1px dashed #ddd; padding-top:20px;">
        <button id="btnRefRumusan" class="btn-secondary" onclick="runAdmin('refreshRumusan')" style="display:none; margin-bottom:10px; width:100%"><i class="material-icons">sync</i> REFRESH RUMUSAN</button>
        <button class="btn-success" onclick="runAdmin('saveMaster')" style="width:100%"><i class="material-icons">cloud_upload</i> SAVE MASTER (AUTO)</button>
      </div>
      <div id="msg-hasil" class="msg-box"></div>
    </div>
  </div>

  <div id="page-muda" class="page-section">
    <div class="pill">MODE: BTB MUDA</div>
    <div class="card">
      <div class="input-group"><div class="input-wrapper"><i class="material-icons">calendar_today</i><input type="date" id="date-muda"></div></div>
      
      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-muda" onchange="renderTeamMuda()"><option value="PKT001G">PKT 001G</option><option value="PKT002">PKT 002</option><option value="PKT003G">PKT 003G</option><option value="PKT004A">PKT 004A</option></select></div>
      </div>

      <div class="input-group">
        <label>TEAM / BLOK</label>
        <div class="input-wrapper"><i class="material-icons">groups</i><select id="sel-team-muda" onchange="clearInput('muda')"></select></div>
      </div>

      <div class="input-group" style="margin-top:20px;">
        <label>BILANGAN TANDAN</label>
        <input type="text" id="val-muda" class="big-input" placeholder="0" inputmode="text" 
               onfocus="onFocusInput('muda')" onblur="onBlurInput('muda')" oninput="onInputHandler('muda')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanmuda" class="btn-success" onclick="saveData('muda')" disabled><i class="material-icons">check_circle</i> SIMPAN MUDA</button>
      </div>
      <div id="msg-muda" class="msg-box"></div>
    </div>
  </div>

  <div id="page-penalti" class="page-section">
    <div class="pill">MODE: PENALTI</div>
    <div class="card">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div class="input-wrapper" style="flex:1"><i class="material-icons">calendar_today</i><input type="date" id="date-penalti"></div>
        <div class="input-wrapper" style="width:130px"><i class="material-icons">category</i><select id="type-penalti" onchange="clearInput('penalti')"><option value="MENGKAL">MENGKAL</option><option value="LAMA">LAMA</option></select></div>
      </div>

      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-penalti" onchange="clearInput('penalti')"><option value="PKT001">PKT 001</option><option value="PKT001G">PKT 001G</option><option value="PKT002">PKT 002</option><option value="PKT003G">PKT 003G</option><option value="PKT004">PKT 004</option></select></div>
      </div>

      <div class="input-group" style="margin-top:20px;">
        <label>BILANGAN TANDAN</label>
        <input type="text" id="val-penalti" class="big-input" placeholder="0" inputmode="text" 
               onfocus="onFocusInput('penalti')" onblur="onBlurInput('penalti')" oninput="onInputHandler('penalti')">
      </div>

      <div class="btn-group">
        <button id="btnSimpanpenalti" class="btn-danger" onclick="saveData('penalti')" disabled><i class="material-icons">error_outline</i> SIMPAN PENALTI</button>
      </div>
      <div id="msg-penalti" class="msg-box"></div>
    </div>
  </div>

  <div id="page-tandan" class="page-section">
    <div class="pill">MODE: REKOD TANDAN</div>
    <div class="card">
      <div class="input-group"><div class="input-wrapper"><i class="material-icons">calendar_today</i><input type="date" id="date-tandan"></div></div>

      <div class="input-group">
        <label>PERINGKAT</label>
        <div class="input-wrapper"><i class="material-icons">layers</i><select id="sel-pkt-tandan" onchange="renderTeamTandan()"><option value="PKT004">PKT 004</option><option value="PKT001">PKT 001</option><option value="PKT002">PKT 002</option><option value="PKT001G">PKT 001G</option><option value="PKT003G">PKT 003G</option></select></div>
      </div>

      <div class="input-group">
        <label>TEAM / BLOK</label>
        <div class="input-wrapper"><i class="material-icons">groups</i><select id="sel-team-tandan" onchange="clearInput('tandan')"></select></div>
      </div>

      <div class="input-group" style="margin-top:20px;">
        <label>BILANGAN TANDAN (BIJI)</label>
        <input type="text" id="val-tandan" class="big-input" placeholder="0" inputmode="text" 
               onfocus="onFocusInput('tandan')" onblur="onBlurInput('tandan')" oninput="onInputHandler('tandan')">
      </div>

      <div class="btn-group">
        <button id="btnSimpantandan" class="btn-warning" onclick="saveData('tandan')" disabled><i class="material-icons">inventory_2</i> SIMPAN TANDAN</button>
      </div>
      <div id="msg-tandan" class="msg-box"></div>
    </div>
  </div>

  <div id="page-admin" class="page-section">
    <div class="pill">ADMIN & LAPORAN</div>
    <div class="card">
      <label>JANA LAPORAN HARIAN</label>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn-secondary" onclick="getReport('PO')">PO</button>
        <button class="btn-secondary" onclick="getReport('RUMUSAN')">RUMUSAN</button>
      </div>
      <button class="btn-primary" onclick="getReport('ALL')" style="margin-top:15px; width:100%"><i class="material-icons">description</i> JANA SEMUA</button>
      <div id="reportResult" class="report-area" style="margin-top:15px; display:none;">
        <textarea id="report-out" rows="8" readonly onclick="this.select()"></textarea>
        <button class="btn-success" onclick="copyText()" style="margin-top:10px; width:100%"><i class="material-icons">content_copy</i> SALIN TEKS</button>
      </div>
    </div>
  </div>

</div>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycbyYtxeXfWrHzEGng8kJMHv_Fk3XrCjtMlOEm_uv8KARkGedxkM_CxDbqQVia0ut5Izl1g/exec"; 

// Data Configs
const HASIL_CFG = { pkt: ["PKT004","PKT001","PKT002","PKT001G","PKT003G","RUMUSAN"], teams: { PKT004: ["BLOK 1","BLOK 2","BLOK 3","BLOK 4","BLOK 5"], PKT002: ["TEAM PKT","TEAM 1","TEAM 2","TEAM TKA","TEAM TKA BAJA"], PKT001G:["HABIBI","P.BOWO","MEGA","TEAM TKA","TEAM TKA BAJA"], PKT003G:["TEAM KIRI","TEAM KANAN","TEAM BLOK C","TEAM TKA","TEAM TKA BAJA"] } };
const MUDA_CFG = { "PKT001G": ["HABIBI", "P.BOWO", "MEGA", "TKA"], "PKT002": ["TEAM PKT", "TEAM 1", "TEAM 2", "TKA"], "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"], "PKT004A": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"] };
const TANDAN_CFG = { "PKT004": ["BLOK 1", "BLOK 2", "BLOK 3", "BLOK 4", "BLOK 5"], "PKT001": ["TKA"], "PKT002": ["TEAM PKT", "TEAM 1", "TEAM 2"], "PKT001G": ["HABIBI", "P.BOWO", "MEGA"], "PKT003G": ["KIRI", "KANAN", "BLOK C", "TKA"] };

let HARVEST_STATS = null;
let FORMULA_STORE = { hasil: '', muda: '', penalti: '', tandan: '' }; // Key huruf kecil

// --- INIT ---
window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  ['date-hasil','date-muda','date-penalti','date-tandan'].forEach(id => document.getElementById(id).value = today);
  renderPeringkatHasil(); renderTeamMuda(); renderTeamTandan();
  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  fetchStats();
};

function toggleMenu() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('open'); }
function nav(id, el) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  if(el) el.classList.add('active');
  toggleMenu();
}

// ==========================================
// SMART FORMULA ENGINE (KEY FIX)
// ==========================================
function onInputHandler(typeRaw) {
    const type = typeRaw.toLowerCase();
    const el = document.getElementById(`val-${type}`);
    const btn = document.getElementById(`btnSimpan${type}`);
    
    // 1. Simpan raw formula (contoh: =5+5) ke memory
    FORMULA_STORE[type] = el.value;
    
    // 2. Unlock button kalau ada isi
    btn.disabled = (el.value.trim() === "");
}

function onBlurInput(typeRaw) {
    const type = typeRaw.toLowerCase();
    const el = document.getElementById(`val-${type}`);
    let val = el.value.trim();
    
    if(!val) { FORMULA_STORE[type] = ""; return; }

    // 3. Auto tambah '=' jika user lupa (tapi ada simbol math)
    if (val.match(/[+\-*\/]/) && !val.startsWith('=')) {
        val = "=" + val;
        FORMULA_STORE[type] = val; // Update memory
    }

    // 4. Paparkan hasil kiraan di skrin (User nampak 10)
    // TAPI dalam FORMULA_STORE masih kekal =5+5
    if (val.startsWith('=')) {
        try {
            let clean = val.substring(1);
            let result = Function('"use strict";return (' + clean + ')')();
            if (!isNaN(result)) {
                el.value = (result % 1 !== 0) ? result.toFixed(2) : result;
            }
        } catch(e) {}
    }
}

function onFocusInput(typeRaw) {
    const type = typeRaw.toLowerCase();
    const el = document.getElementById(`val-${type}`);
    // 5. Bila user tekan balik, tunjuk formula asal (=5+5) untuk edit
    if (FORMULA_STORE[type] && FORMULA_STORE[type].startsWith('=')) {
        el.value = FORMULA_STORE[type];
    }
}

function clearInput(typeRaw) {
    const type = typeRaw.toLowerCase();
    document.getElementById(`val-${type}`).value = "";
    FORMULA_STORE[type] = "";
    document.getElementById(`btnSimpan${type}`).disabled = true;
}

// ==========================================
// SAVE HANDLER (FINAL FIX)
// ==========================================
async function saveData(typeRaw) {
  const type = typeRaw.toLowerCase();
  
  // 6. AMBIL FORMULA DARI MEMORY, BUKAN DARI SKRIN
  // Kalau formula kosong (user tak pernah blur/focus), ambil value skrin
  let valToSend = FORMULA_STORE[type] || document.getElementById(`val-${type}`).value;
  
  if(!valToSend) return alert("Sila isi nilai!");
  
  // 7. Safety check terakhir sebelum hantar ke Google Sheet
  if (valToSend.match(/[+\-*\/]/) && !valToSend.startsWith('=')) {
      valToSend = "=" + valToSend;
  }

  document.getElementById('loader').style.display = 'flex';
  
  let payload = {};
  if (type === 'hasil') {
    payload = {
      peringkat: document.getElementById('sel-pkt-hasil').value,
      idx: document.getElementById('sel-team-hasil').value,
      day: Number(document.getElementById('date-hasil').value.split('-')[2]),
      fullDate: document.getElementById('date-hasil').value
    };
    if (document.getElementById('mode-hasil').value === "TAN") { payload.action = "saveTan"; payload.tan = valToSend; } 
    else { payload.action = "savePusTuai"; payload.tarikh = payload.fullDate; payload.hektar = valToSend; }
  } 
  else if (type === 'muda') {
    payload = { action: "saveMuda", peringkat: document.getElementById('sel-pkt-muda').value, teamName: document.getElementById('sel-team-muda').value, val: valToSend, tarikh: document.getElementById('date-muda').value };
  }
  else if (type === 'penalti') {
    payload = { action: "savePenalti", type: document.getElementById('type-penalti').value, peringkat: document.getElementById('sel-pkt-penalti').value, val: valToSend, tarikh: document.getElementById('date-penalti').value };
  }
  else if (type === 'tandan') {
    payload = { action: "saveTandan", peringkat: document.getElementById('sel-pkt-tandan').value, teamName: document.getElementById('sel-team-tandan').value, val: valToSend, tarikh: document.getElementById('date-tandan').value };
  }

  try {
    const req = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: payload.action, data: payload }) });
    const res = await req.json();
    document.getElementById('loader').style.display = 'none';
    
    if(res.ok) {
      showMsg(document.getElementById(`msg-${type}`), res.message, true);
      clearInput(type);
      if(type === 'hasil' && document.getElementById('mode-hasil').value === "PUS_TUAI") fetchStats();
    } else {
      showMsg(document.getElementById(`msg-${type}`), res.message, false);
    }
  } catch(e) {
    document.getElementById('loader').style.display = 'none';
    alert("Ralat Sambungan Internet!");
  }
}

// ==========================================
// RENDER & UTILS
// ==========================================
function renderPeringkatHasil() {
  const sel = document.getElementById('sel-pkt-hasil');
  const mode = document.getElementById('mode-hasil').value;
  const list = (mode === "PUS_TUAI") ? HASIL_CFG.pkt.filter(x => x !== "RUMUSAN") : HASIL_CFG.pkt;
  sel.innerHTML = list.map(x => `<option>${x}</option>`).join("");
  document.getElementById('lbl-val-hasil').textContent = (mode==="TAN") ? "NILAI (TAN)" : "NILAI (HEKTAR)";
  renderTeamHasil();
}

function renderTeamHasil() {
  const p = document.getElementById('sel-pkt-hasil').value;
  const wrap = document.getElementById('wrap-team-hasil');
  const sel = document.getElementById('sel-team-hasil');
  const mode = document.getElementById('mode-hasil').value;
  
  const isRumusan = (p === "RUMUSAN");
  document.getElementById('btnRefRumusan').style.display = isRumusan ? 'block' : 'none';
  document.getElementById('btnSimpanhasil').style.display = isRumusan ? 'none' : 'flex';
  wrap.style.display = (isRumusan || p === "PKT001") ? 'none' : 'block';
  
  const inp = document.getElementById('val-hasil');
  inp.disabled = isRumusan;
  inp.placeholder = isRumusan ? "Tekan Refresh" : "0.00";
  if(isRumusan) inp.value = ""; 

  const info = document.getElementById('info-luas');
  const box = document.getElementById('box-status-tuai');
  if(HARVEST_STATS && HARVEST_STATS[p]) {
     info.textContent = `â€¢ ${HARVEST_STATS[p].luas.toFixed(2)} Ha`;
     if(mode === "PUS_TUAI" && !isRumusan) {
        box.style.display = 'flex';
        document.getElementById('valSiap').textContent = HARVEST_STATS[p].siap.toFixed(2) + " Ha";
        const d = Number(document.getElementById('date-hasil').value.split('-')[2]);
        let target = HARVEST_STATS[p].luas;
        if(d >= 16 || HARVEST_STATS[p].siap > HARVEST_STATS[p].luas) target *= 2;
        document.getElementById('valBaki').textContent = (target - HARVEST_STATS[p].siap).toFixed(2) + " Ha";
     } else box.style.display = 'none';
  } else { info.textContent = ""; box.style.display = 'none'; }

  if(!isRumusan && p!=="PKT001") {
    sel.innerHTML = (HASIL_CFG.teams[p] || []).map((t,i) => `<option value="${i}">${t}</option>`).join("");
  }
  clearInput('hasil');
}

function renderTeamMuda() {
  const p = document.getElementById('sel-pkt-muda').value;
  document.getElementById('sel-team-muda').innerHTML = (MUDA_CFG[p]||[]).map(t => `<option value="${t}">${t}</option>`).join("");
  clearInput('muda');
}
function renderTeamTandan() {
  const p = document.getElementById('sel-pkt-tandan').value;
  document.getElementById('sel-team-tandan').innerHTML = (TANDAN_CFG[p]||[]).map(t => `<option value="${t}">${t}</option>`).join("");
  clearInput('tandan');
}

async function fetchStats() {
  try {
    const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getHarvestStatus', data: {} }) });
    const res = await r.json();
    if(res.ok) { HARVEST_STATS = res.stats; renderTeamHasil(); }
  } catch(e){}
}

async function runAdmin(act) {
  if(act !== 'refreshRumusan' && !confirm("Pasti?")) return;
  document.getElementById('loader').style.display = 'flex';
  const d = document.getElementById('date-hasil').value;
  try {
      const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: act, data: { peringkat: document.getElementById('sel-pkt-hasil').value, fullDate: d, day: Number(d.split('-')[2]) } }) });
      const res = await r.json();
      document.getElementById('loader').style.display = 'none';
      if(res.ok) {
          if(act === 'refreshRumusan' && res.tan) document.getElementById('val-hasil').value = Number(res.tan).toFixed(2);
          alert(res.message);
      } else alert(res.message);
  } catch(e){ document.getElementById('loader').style.display = 'none'; alert("Error"); }
}

async function getReport(t) {
  document.getElementById('loader').style.display = 'flex';
  const r = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'genReport', data: t }) });
  const res = await r.json();
  document.getElementById('loader').style.display = 'none';
  if(res.ok) {
    document.getElementById('report-out').value = res.reportText;
    document.getElementById('reportResult').style.display = 'block';
  }
}

function copyText() {
  const t = document.getElementById('report-out'); t.select(); document.execCommand('copy'); alert("Disalin!");
}

function showMsg(el, txt, success) {
  el.textContent = txt; el.className = "msg-box " + (success ? "msg-success" : "msg-error");
  el.style.display = "block"; setTimeout(()=>el.style.display="none", 3000);
}
</script>
</body>
</html>

